<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>我应该如何看代码 - liulangren Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="liulangren blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="liulangren blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="每次看一个模块源码都比较痛苦，在 kernel 的代码海洋里面像一只无头苍蝇一样，看来半天却不知所云，记录一下之后在看某个模块源码时 应该注意什么，比较快的熟悉，警醒自己！ 庞大的linux内核现在是 2021-01-11号，上个月linus发布了 Linux-5.10 LTS版本，往往每年的最后一个 kernel 版本就是作为LTS的版本，今年是12月13号。 linus 会在每个大版本发布之后"><meta property="og:type" content="blog"><meta property="og:title" content="我应该如何看代码"><meta property="og:url" content="https://liulangrenaaa.github.io/2021/01/11/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/%E6%88%91%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E7%9C%8B%E4%BB%A3%E7%A0%81/"><meta property="og:site_name" content="liulangren Blog"><meta property="og:description" content="每次看一个模块源码都比较痛苦，在 kernel 的代码海洋里面像一只无头苍蝇一样，看来半天却不知所云，记录一下之后在看某个模块源码时 应该注意什么，比较快的熟悉，警醒自己！ 庞大的linux内核现在是 2021-01-11号，上个月linus发布了 Linux-5.10 LTS版本，往往每年的最后一个 kernel 版本就是作为LTS的版本，今年是12月13号。 linus 会在每个大版本发布之后"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liulangrenaaa.github.io/img/og_image.png"><meta property="article:published_time" content="2021-01-11T15:00:00.000Z"><meta property="article:modified_time" content="2021-01-15T11:33:39.371Z"><meta property="article:author" content="Su Hui"><meta property="article:tag" content="生活感悟"><meta property="article:tag" content="read code"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liulangrenaaa.github.io/2021/01/11/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/%E6%88%91%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E7%9C%8B%E4%BB%A3%E7%A0%81/"},"headline":"liulangren Blog","image":["https://liulangrenaaa.github.io/img/og_image.png"],"datePublished":"2021-01-11T15:00:00.000Z","dateModified":"2021-01-15T11:33:39.371Z","author":{"@type":"Person","name":"Su Hui"},"description":"每次看一个模块源码都比较痛苦，在 kernel 的代码海洋里面像一只无头苍蝇一样，看来半天却不知所云，记录一下之后在看某个模块源码时 应该注意什么，比较快的熟悉，警醒自己！ 庞大的linux内核现在是 2021-01-11号，上个月linus发布了 Linux-5.10 LTS版本，往往每年的最后一个 kernel 版本就是作为LTS的版本，今年是12月13号。 linus 会在每个大版本发布之后"}</script><link rel="canonical" href="https://liulangrenaaa.github.io/2021/01/11/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/%E6%88%91%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E7%9C%8B%E4%BB%A3%E7%A0%81/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?cabdc5b9b70bb83fa919a6ebeb439f93";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=PTKX6HMR55" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'PTKX6HMR55');</script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-11T15:00:00.000Z" title="1/11/2021, 11:00:00 PM">2021-01-11</time>发表</span><span class="level-item"><time dateTime="2021-01-15T11:33:39.371Z" title="1/15/2021, 7:33:39 PM">2021-01-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/">生活感悟</a></span><span class="level-item">8 分钟读完 (大约1225个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">我应该如何看代码</h1><div class="content"><p>每次看一个模块源码都比较痛苦，在 <code>kernel</code> 的代码海洋里面像一只无头苍蝇一样，看来半天却<br>不知所云，记录一下之后在看某个模块源码时 应该注意什么，比较快的熟悉，警醒自己！</p>
<h2 id="庞大的linux内核"><a href="#庞大的linux内核" class="headerlink" title="庞大的linux内核"></a>庞大的linux内核</h2><p>现在是 2021-01-11号，上个月linus发布了 Linux-5.10 LTS版本，往往每年的最后一个 kernel 版本就是作为LTS的版本，今年是12月13号。</p>
<p>linus 会在每个大版本发布之后都会 开启 一个merge window的时间，这个时间大家都可以尽量<br>的合入之前早就开发好的已经在next tree的 patch，大概有一两周？今年这时候恰好是圣诞节，<br>老外是基本周末都不会工作的，更何况是 <code>圣诞+元旦</code> 这种节日了，看了基本 2020-12-23 – 2021-01-04 都是没有daily next tree 版本更新的。</p>
<p>A total of 1,971 developers contributed to 5.10 — again, just short of the record set by 5.8. Of those developers, 252 (just under 13%) made their first contribution in 5.10; that is the lowest number seen since 5.6. The most active 5.10 developers were:</p>
<p><a target="_blank" rel="noopener" href="https://lwn.net/Articles/839772/">Linux 5.10代码统计</a></p>
<h2 id="新的模块应该如何涉及"><a href="#新的模块应该如何涉及" class="headerlink" title="新的模块应该如何涉及"></a>新的模块应该如何涉及</h2><p>首先要高明白他是干什么的</p>
<ol>
<li>结合注释去看，谷歌翻译，vscode在线、离线插件都很好用</li>
<li>结合 git log 看：<br> git log -S’xxx’ file_name</li>
<li>根据Makefile看：如果这个目录下Makefile 都没直接包含这个文件.o<br>需要使能之后才会编译到内核中的话，结合是否工作实际需要再看</li>
<li>谷歌、百度：中文 英文都可以作为关键次搜索</li>
<li>LWN 找到Archives，看看有没有介绍的文章</li>
<li>看看 Documents 目录下有没有介绍的文档</li>
<li>看这个模块 关键数据结构 和关键数据结构数据成员 如 struct_task struct_mm<br>address_space等</li>
</ol>
<h3 id="新的子系统"><a href="#新的子系统" class="headerlink" title="新的子系统"></a>新的子系统</h3><ol>
<li>知道模块子系统作用</li>
<li>找个方法实践一下，比如 docker 可以很好实践 cgroups</li>
<li>关键数据结构</li>
<li>导出到用户空间的接口，看他在 kernel中实现<br>比如<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@127ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# ls</span><br><span class="line">aio-max-nr    dir-notify-enable  inode-nr          leases-enable  overflowgid           pipe-user-pages-soft  protected_symlinks</span><br><span class="line">aio-nr        epoll              inode-state       mount-max      overflowuid           protected_fifos       quota</span><br><span class="line">binfmt_misc   file-max           inotify           mqueue         pipe-max-size         protected_hardlinks   suid_dumpable</span><br><span class="line">dentry-state  file-nr            lease-break-time  nr_open        pipe-user-pages-hard  protected_regular     verity</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs#</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs#</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-nr</span><br><span class="line">3200    0       9223372036854775807</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs# cat file-max</span><br><span class="line">9223372036854775807</span><br><span class="line">tencent_clould@ubuntu: &#x2F;proc&#x2F;sys&#x2F;fs#</span><br></pre></td></tr></table></figure>

</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">static struct ctl_table fs_table[] &#x3D; &#123;</span><br><span class="line">	&#123;</span><br><span class="line">		.procname	&#x3D; &quot;inode-nr&quot;,</span><br><span class="line">		.data		&#x3D; &amp;inodes_stat,</span><br><span class="line">		.maxlen		&#x3D; 2*sizeof(long),</span><br><span class="line">		.mode		&#x3D; 0444,</span><br><span class="line">		.proc_handler	&#x3D; proc_nr_inodes,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.procname	&#x3D; &quot;inode-state&quot;,</span><br><span class="line">		.data		&#x3D; &amp;inodes_stat,</span><br><span class="line">		.maxlen		&#x3D; 7*sizeof(long),</span><br><span class="line">		.mode		&#x3D; 0444,</span><br><span class="line">		.proc_handler	&#x3D; proc_nr_inodes,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.procname	&#x3D; &quot;file-nr&quot;,</span><br><span class="line">		.data		&#x3D; &amp;files_stat,</span><br><span class="line">		.maxlen		&#x3D; sizeof(files_stat),</span><br><span class="line">		.mode		&#x3D; 0444,</span><br><span class="line">		.proc_handler	&#x3D; proc_nr_files,</span><br><span class="line">	&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="如何深入"><a href="#如何深入" class="headerlink" title="如何深入"></a>如何深入</h2><p>比如我知道 page_cache 的大概了，也知道他的作用，但是看代码的时候比较迷茫？</p>
<ol>
<li><p>看看 page_cache 的API</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;mm# grep &quot;EXPORT_SYMBOL&quot; .&#x2F;filemap.c -nr</span><br><span class="line">279:EXPORT_SYMBOL(delete_from_page_cache);</span><br><span class="line">377:EXPORT_SYMBOL(filemap_check_errors);</span><br><span class="line">437:EXPORT_SYMBOL(filemap_fdatawrite);</span><br><span class="line">444:EXPORT_SYMBOL(filemap_fdatawrite_range);</span><br><span class="line">459:EXPORT_SYMBOL(filemap_flush);</span><br><span class="line">502:EXPORT_SYMBOL(filemap_range_has_page);</span><br><span class="line">557:EXPORT_SYMBOL(filemap_fdatawait_range);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在.c 文件中搜索trace_ 看看，找到他的静态追踪点 <code>tracepoints</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">amd_server@130ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;mm# grep &quot;trace_&quot; .&#x2F;filemap.c -nr</span><br><span class="line">236:    trace_mm_filemap_delete_from_page_cache(page);</span><br><span class="line">354:            trace_mm_filemap_delete_from_page_cache(pvec-&gt;pages[i]);</span><br><span class="line">683:    trace_filemap_set_wb_err(mapping, eseq);</span><br><span class="line">724:            trace_file_check_and_advance_wb_err(file, old);</span><br><span class="line">902:    trace_mm_filemap_add_to_page_cache(page);</span><br><span class="line">amd_server@ubuntu: ~&#x2F;workspace&#x2F;linux-stable&#x2F;mm#</span><br></pre></td></tr></table></figure>
</li>
<li><p>直接使用 bpftrace -l 这个根据搜索你的模块，看看有那些比较重要的函数，这些重要函数往<br>往是掌握这个模块的关键，也是经常出现问题需要debug 或者观测的地方，所以 kernel 才会为他<br>设置一个静态追踪点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="lin
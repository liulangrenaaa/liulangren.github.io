<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>kprobes 原理与使用 - liulangren Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="liulangren blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="liulangren blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="原理kprobes使用最基本的方式就是写一个 kpobes 相关的 module，编译安装到 kernel里面，实现想要的功能，但是由于以下原因，一般使用中不常用 module的方式：  kernel module 对于仅仅想使用的人来说难度较大 kernel module 有问题的话直接会导致 panic等严重问题 kernel module 编译安装，相比与其他方式资源消耗较大  除了直接使用"><meta property="og:type" content="blog"><meta property="og:title" content="kprobes 原理与使用"><meta property="og:url" content="https://liulangrenaaa.github.io/2021/01/29/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/%E6%80%A7%E8%83%BD%E7%A8%B3%E5%AE%9A%E6%80%A7/kprobes%20%E5%8E%9F%E7%90%86%E4%B8%8E%E4%BD%BF%E7%94%A8/"><meta property="og:site_name" content="liulangren Blog"><meta property="og:description" content="原理kprobes使用最基本的方式就是写一个 kpobes 相关的 module，编译安装到 kernel里面，实现想要的功能，但是由于以下原因，一般使用中不常用 module的方式：  kernel module 对于仅仅想使用的人来说难度较大 kernel module 有问题的话直接会导致 panic等严重问题 kernel module 编译安装，相比与其他方式资源消耗较大  除了直接使用"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liulangrenaaa.github.io/img/og_image.png"><meta property="article:published_time" content="2021-01-29T11:00:00.000Z"><meta property="article:modified_time" content="2021-01-31T11:08:57.448Z"><meta property="article:author" content="Su Hui"><meta property="article:tag" content="kprobes"><meta property="article:tag" content="kretprobes"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liulangrenaaa.github.io/2021/01/29/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/%E6%80%A7%E8%83%BD%E7%A8%B3%E5%AE%9A%E6%80%A7/kprobes%20%E5%8E%9F%E7%90%86%E4%B8%8E%E4%BD%BF%E7%94%A8/"},"headline":"liulangren Blog","image":["https://liulangrenaaa.github.io/img/og_image.png"],"datePublished":"2021-01-29T11:00:00.000Z","dateModified":"2021-01-31T11:08:57.448Z","author":{"@type":"Person","name":"Su Hui"},"description":"原理kprobes使用最基本的方式就是写一个 kpobes 相关的 module，编译安装到 kernel里面，实现想要的功能，但是由于以下原因，一般使用中不常用 module的方式：  kernel module 对于仅仅想使用的人来说难度较大 kernel module 有问题的话直接会导致 panic等严重问题 kernel module 编译安装，相比与其他方式资源消耗较大  除了直接使用"}</script><link rel="canonical" href="https://liulangrenaaa.github.io/2021/01/29/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/%E6%80%A7%E8%83%BD%E7%A8%B3%E5%AE%9A%E6%80%A7/kprobes%20%E5%8E%9F%E7%90%86%E4%B8%8E%E4%BD%BF%E7%94%A8/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?cabdc5b9b70bb83fa919a6ebeb439f93";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=PTKX6HMR55" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'PTKX6HMR55');</script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-29T11:00:00.000Z" title="1/29/2021, 7:00:00 PM">2021-01-29</time>发表</span><span class="level-item"><time dateTime="2021-01-31T11:08:57.448Z" title="1/31/2021, 7:08:57 PM">2021-01-31</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/kernel-debug/">kernel debug</a></span><span class="level-item">10 分钟读完 (大约1510个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">kprobes 原理与使用</h1><div class="content"><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h2 id="kprobes使用"><a href="#kprobes使用" class="headerlink" title="kprobes使用"></a>kprobes使用</h2><p>最基本的方式就是写一个 kpobes 相关的 module，编译安装到 kernel里面，实现想要的功能，但是由于以下原因，一般使用中不常用 <code>module</code>的方式：</p>
<ol>
<li>kernel module 对于仅仅想使用的人来说难度较大</li>
<li>kernel module 有问题的话直接会导致 panic等严重问题</li>
<li>kernel module 编译安装，相比与其他方式资源消耗较大</li>
</ol>
<p>除了直接使用 <code>kernel module</code> 的方式外，还可以使用 <code>ftrace 框架</code>，<code>perf</code>，<code>bpftrace</code>等集成好的工具框架。</p>
<h3 id="通过kernel-module-使用"><a href="#通过kernel-module-使用" class="headerlink" title="通过kernel module 使用"></a>通过kernel module 使用</h3><p>参考写的<a target="_blank" rel="noopener" href="https://github.com/liulangrenaaa/test_modules/blob/main/trace/kprobes/kprobe_trace.c">test case</a><br>后面发现 kernel 的samples也实现了这个<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/tree/master/samples/kprobes">example</a>。。<br>编译安装之后，随便运行一些命令，<code>dmesg</code>看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[  282.874169] Planted kprobe at 00000000ef62436b</span><br><span class="line">[  282.899730] &lt;kernel_clone&gt; pre_handler: p-&gt;addr &#x3D; 00000000ef62436b, ip &#x3D; ffffffffafe69fa1, flags &#x3D; 0x206</span><br><span class="line">[  282.899732] &lt;kernel_clone&gt; post_handler: p-&gt;addr &#x3D; 00000000ef62436b, flags &#x3D; 0x206</span><br><span class="line">[  288.039369] &lt;kernel_clone&gt; pre_handler: p-&gt;addr &#x3D; 00000000ef62436b, ip &#x3D; ffffffffafe69fa1, flags &#x3D; 0x206</span><br><span class="line">[  288.039373] &lt;kernel_clone&gt; post_handler: p-&gt;addr &#x3D; 00000000ef62436b, flags &#x3D; 0x206</span><br><span class="line">[  289.401793] &lt;kernel_clone&gt; pre_handler: p-&gt;addr &#x3D; 00000000ef62436b, ip &#x3D; ffffffffafe69fa1, flags &#x3D; 0x206</span><br><span class="line">[  289.401794] &lt;kernel_clone&gt; post_handler: p-&gt;addr &#x3D; 00000000ef62436b, flags &#x3D; 0x206</span><br><span class="line">[  294.421145] &lt;kernel_clone&gt; pre_handler: p-&gt;addr &#x3D; 00000000ef62436b, ip &#x3D; ffffffffafe69fa1, flags &#x3D; 0x206</span><br><span class="line">[  294.421148] &lt;kernel_clone&gt; post_handler: p-&gt;addr &#x3D; 00000000ef62436b, flags &#x3D; 0x206</span><br><span class="line">[  294.428760] &lt;kernel_clone&gt; pre_handler: p-&gt;addr &#x3D; 00000000ef62436b, ip &#x3D; ffffffffafe69fa1, flags &#x3D; 0x206</span><br><span class="line">[  294.428764] &lt;kernel_clone&gt; post_handler: p-&gt;addr &#x3D; 00000000ef62436b, flags &#x3D; 0x206</span><br><span class="line">[  297.028993] &lt;kernel_clone&gt; pre_handler: p-&gt;addr &#x3D; 00000000ef62436b, ip &#x3D; ffffffffafe69fa1, flags &#x3D; 0x206</span><br><span class="line">[  297.028998] &lt;kernel_clone&gt; post_handler: p-&gt;addr &#x3D; 00000000ef62436b, flags &#x3D; 0x206</span><br><span class="line">[  299.595467] &lt;kernel_clone&gt; pre_handler: p-&gt;addr &#x3D; 00000000ef62436b, ip &#x3D; ffffffffafe69fa1, flags &#x3D; 0x206</span><br><span class="line">[  299.595471] &lt;kernel_clone&gt; post_handler: p-&gt;addr &#x3D; 00000000ef62436b, flags &#x3D; 0x206</span><br><span class="line">[ 1137.315517] kprobe at 00000000ef62436b unregistered</span><br></pre></td></tr></table></figure>

<p>可以看到每次运行到 <code>kernel_fork</code> 位置，都会触发 <code>pre_handler</code>，结束也会触发<code>post_handler</code>。</p>
<h3 id="与-trace-框架结合使用"><a href="#与-trace-框架结合使用" class="headerlink" title="与 trace 框架结合使用"></a>与 trace 框架结合使用</h3><p><code>trace</code> 框架中，与 <code>kprobe</code>相关的节点有如下节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;kprobe_events-----------------------配置kprobe事件属性，增加事件之后会在kprobes下面生成对应目录。</span><br><span class="line">&#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;kprobe_profile----------------------kprobe事件统计属性文件。</span><br><span class="line">&#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;kprobes&#x2F;&lt;GRP&gt;&#x2F;&lt;EVENT&gt;&#x2F;enabled-------使能kprobe事件</span><br><span class="line">&#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;kprobes&#x2F;&lt;GRP&gt;&#x2F;&lt;EVENT&gt;&#x2F;filter--------过滤kprobe事件</span><br><span class="line">&#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;kprobes&#x2F;&lt;GRP&gt;&#x2F;&lt;EVENT&gt;&#x2F;format--------查询kprobe事件显示格式</span><br></pre></td></tr></table></figure>

<p>可以通过如下方式配置 <code>kprobe</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p[:[GRP&#x2F;]EVENT] [MOD:]SYM[+offs]|MEMADDR [FETCHARGS]-------------------设置一个probe探测点</span><br><span class="line">r[:[GRP&#x2F;]EVENT] [MOD:]SYM[+0] [FETCHARGS]------------------------------设置一个return probe探测点</span><br><span class="line">-:[GRP&#x2F;]EVENT----------------------------------------------------------删除一个探测点</span><br></pre></td></tr></table></figure>




<p>examples:</p>
<p>添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#39;p:myprobe do_sys_open dfd&#x3D;%ax filename&#x3D;%dx flags&#x3D;%cx mode&#x3D;+4($stack)&#39; &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;kprobe_events</span><br><span class="line">echo &#39;r:myretprobe do_sys_open ret&#x3D;$retval&#39; &gt;&gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;kprobe_events</span><br></pre></td></tr></table></figure>

<p>开始</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;events&#x2F;kprobes&#x2F;myprobe&#x2F;enable</span><br><span class="line">echo 1 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;events&#x2F;kprobes&#x2F;myretprobe&#x2F;enable</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@rlk-Standard-PC-i440FX-PIIX-1996:&#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing# cat &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;trace</span><br><span class="line"># tracer: nop</span><br><span class="line">#</span><br><span class="line"># entries-in-buffer&#x2F;entries-written: 103&#x2F;103   #P:4</span><br><span class="line">#</span><br><span class="line">#                                _-----&#x3D;&gt; irqs-off</span><br><span class="line">#                               &#x2F; _----&#x3D;&gt; need-resched</span><br><span class="line">#                              | &#x2F; _---&#x3D;&gt; hardirq&#x2F;softirq</span><br><span class="line">#                              || &#x2F; _--&#x3D;&gt; preempt-depth</span><br><span class="line">#                              ||| &#x2F;     delay</span><br><span clas
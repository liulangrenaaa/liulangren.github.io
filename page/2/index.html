<!DOCTYPE html>
<html lang="cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liulangrenaaa.github.io","root":"/","scheme":"Muse","version":"8.0.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="liulangren Blog">
<meta property="og:url" content="https://liulangrenaaa.github.io/page/2/index.html">
<meta property="og:site_name" content="liulangren Blog">
<meta property="og:locale">
<meta property="article:author" content="Su Hui">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://liulangrenaaa.github.io/page/2/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'cn'
  };
</script>

  <title>liulangren Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">liulangren Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Su Hui</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://liulangrenaaa.github.io/2021/01/07/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/tools/vmtouch%20%E8%A7%82%E6%B5%8B%E6%96%87%E4%BB%B6page%20cache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Hui">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liulangren Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/07/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/tools/vmtouch%20%E8%A7%82%E6%B5%8B%E6%96%87%E4%BB%B6page%20cache/" class="post-title-link" itemprop="url">vmtouch 观测文件page cache</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-01-07 20:00:40 / Modified: 20:16:27" itemprop="dateCreated datePublished" datetime="2021-01-07T20:00:40+08:00">2021-01-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">linux内核</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="vmtouch-介绍"><a href="#vmtouch-介绍" class="headerlink" title="vmtouch 介绍"></a>vmtouch 介绍</h2><p><code>便携式文件系统缓存诊断和控制</code> 是 <code>vmtouch</code> 作者对于vmtouch的的定义。<br>首先他可以很方便的知道某一个文件当前有多少在 kernel memory 里面作为<br><code>pagecache</code> 存在。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ vmtouch haha</span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">  Resident Pages: 11584&#x2F;1024000  45M&#x2F;3G  1.13%</span><br><span class="line">         Elapsed: 0.031335 seconds</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ cat haha</span><br><span class="line">^C</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ vmtouch haha</span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">  Resident Pages: 36800&#x2F;1024000  143M&#x2F;3G  3.59%</span><br><span class="line">         Elapsed: 0.033472 seconds</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$</span><br></pre></td></tr></table></figure>

<p>明显可以看到在经过 <code>cat</code> 访问之后 文件更多部分被读入 memory，作为 pagecache。</p>
<p>作者对于他的功能介绍：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 发现你的操作系统正在缓存哪些文件</span><br><span class="line">2. 告诉操作系统缓存或清除某些文件或文件区域</span><br><span class="line">3. 将文件锁定在内存中，这样操作系统就不会删除它们</span><br><span class="line">4. 在服务器故障转移时保留虚拟内存配置文件</span><br><span class="line">5. 保持“热备”文件服务器</span><br><span class="line">6. 绘制文件系统缓存随时间的使用情况</span><br><span class="line">7. 维护缓存使用的“软配额”</span><br></pre></td></tr></table></figure>



<h2 id="vmtouch-使用"><a href="#vmtouch-使用" class="headerlink" title="vmtouch 使用"></a>vmtouch 使用</h2><h3 id="控制增加-pagecache"><a href="#控制增加-pagecache" class="headerlink" title="控制增加 pagecache"></a>控制增加 pagecache</h3><p>可以将整个文件读入内存，其实我们通过访问这个文件（从头到尾）也可以做到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ vmtouch -vt haha</span><br><span class="line">haha</span><br><span class="line">[OOo                                                         ] 44737&#x2F;1024000</span><br><span class="line">[OOOOOo                                                      ] 90849&#x2F;1024000</span><br><span class="line">[OOOOOOOOo                                                   ] 150209&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOo                                               ] 215937&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOo                                            ] 271489&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOo                                        ] 326305&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOo                                      ] 370721&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOo                                   ] 414305&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOo                                ] 469697&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo                             ] 524289&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo                          ] 577153&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo                     ] 652481&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo                  ] 705953&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo               ] 757281&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo            ] 810593&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo        ] 876769&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo      ] 920545&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOo  ] 973473&#x2F;1024000</span><br><span class="line">[OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO] 1024000&#x2F;1024000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">   Touched Pages: 1024000 (3G)</span><br><span class="line">         Elapsed: 9.4376 seconds</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$</span><br></pre></td></tr></table></figure>


<h3 id="控制减少-pagecache"><a href="#控制减少-pagecache" class="headerlink" title="控制减少 pagecache"></a>控制减少 pagecache</h3><p>evict a file from memory<br>将一个文件的pagecache 从内存中移除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ vmtouch -ve haha</span><br><span class="line">Evicting haha</span><br><span class="line"></span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">   Evicted Pages: 1024000 (3G)</span><br><span class="line">         Elapsed: 0.085208 seconds</span><br></pre></td></tr></table></figure>

<p>与<code>drop cache</code>不同，<code>vmtouch</code>做到了精准控制单个文件page_cache的效果，而 drop cache不行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-Inspiron-5548:&#x2F;home&#x2F;ubuntu# echo 1 &gt;  &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;drop_caches</span><br><span class="line">root@ubuntu-Inspiron-5548:&#x2F;home&#x2F;ubuntu# echo 3 &gt;  &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;drop_caches</span><br></pre></td></tr></table></figure>

<h3 id="保持文件在pagecache中"><a href="#保持文件在pagecache中" class="headerlink" title="保持文件在pagecache中"></a>保持文件在pagecache中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ vmtouch -dl haha</span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$ vmtouch: FATAL: mlock: haha (Cannot allocate memory)</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu-Inspiron-5548:~$</span><br></pre></td></tr></table></figure>
<p>(内存4G，文件4G 是没办法将文件常驻在 内存中的)<br>从此报错信息可以看出 <code>vmtouch</code> 也是通过 <code>mlock</code> 系统调用来实现 文件内容 或者 文件目录内容锁定在 内存中的</p>
<p><a target="_blank" rel="noopener" href="https://hoytech.com/vmtouch/">vmtouch 作者的文章</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://liulangrenaaa.github.io/2021/01/07/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/systemTap/examples/SystemTap%20examples/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Hui">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liulangren Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/07/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/systemTap/examples/SystemTap%20examples/" class="post-title-link" itemprop="url">SystemTap examples</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-01-07 10:00:40 / Modified: 20:16:27" itemprop="dateCreated datePublished" datetime="2021-01-07T10:00:40+08:00">2021-01-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">linux内核</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>SystemTap脚本集锦<br>本章列举了若干可用于监控和调查内核子系统的SystemTap脚本。所有这些示例都能在 <code>centos</code>的<br> <code>/usr/share/systemtap/testsuite/systemtap.examples/</code>下找到。</p>
<h2 id="SystemTap脚本集锦"><a href="#SystemTap脚本集锦" class="headerlink" title="SystemTap脚本集锦"></a>SystemTap脚本集锦</h2><p><a target="_blank" rel="noopener" href="https://spacewander.gitbooks.io/systemtapbeginnersguide_zh/content/5_UsefulSystemTapScripts.html">SystemTap脚本集锦</a></p>
<h2 id="解读错误信息"><a href="#解读错误信息" class="headerlink" title="解读错误信息"></a>解读错误信息</h2><p><a target="_blank" rel="noopener" href="https://spacewander.gitbooks.io/systemtapbeginnersguide_zh/content/6_UnderstandingSystemTapErrors.html">解读错误信息</a></p>
<p> 参考<a target="_blank" rel="noopener" href="https://spacewander.gitbooks.io/systemtapbeginnersguide_zh/content/2_3_RunningSystemTapScripts.html">SystemTap 内核文档</a></p>
<p>参考 <a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html-single/systemtap_beginners_guide/index">RedHat systemTap 文档</a></p>
<p>参考 <a target="_blank" rel="noopener" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/index.html">文档</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://liulangrenaaa.github.io/2020/12/19/qemu/%E6%88%91%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AEqemu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Hui">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liulangren Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/19/qemu/%E6%88%91%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AEqemu/" class="post-title-link" itemprop="url">我的服务器配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-19 14:47:40" itemprop="dateCreated datePublished" datetime="2020-12-19T14:47:40+08:00">2020-12-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-01-11 16:51:13" itemprop="dateModified" datetime="2021-01-11T16:51:13+08:00">2021-01-11</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/server/" itemprop="url" rel="index"><span itemprop="name">server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h2><p>我之前一直是使用 <code>笔记本windows+ubuntu虚拟机</code> 的开发配置，但是这样有几个限制：</p>
<ol>
<li>ubuntu 虚拟机比较耗费资源，一到夏天笔记本风扇狂转，影响体验</li>
<li>只在本地使用没有问题，但是有时候还想在公司或者出差的时候使用</li>
</ol>
<p>基于以上种种限制，我就搞了腾讯云的服务器，<code>1H2G1M3Y</code> 价格好像是 300￥，还是比较便宜的。</p>
<p>但是直到前些天才真正用起来，主要用于编译和测试，但是一直有几个缺点：</p>
<ol>
<li>云服务器基本都是基于 KVM的，然后他还禁止了租户继续使用KVM进行虚拟化</li>
<li>云服务器禁止了 邮件服务的端口，导致无法收发邮件</li>
<li>云服务器在低配置（1核心2G）下，费用较低，一旦配置升高，价格急剧上升，性价比不高</li>
<li>1核2G用来编译效率太低</li>
<li>云服务器带宽资源比较昂贵，在本地连接云服务器的时候经常会需要连接好久才能连接上</li>
</ol>
<p>考虑最近AMD cpu很强势，便配置了一个AMD 4650G的ITX机器，用作我自己的服务器。</p>
<h2 id="物理服务器安装"><a href="#物理服务器安装" class="headerlink" title="物理服务器安装"></a>物理服务器安装</h2><p>我直接选择了 ubuntu20.04.1 版本，通过UltraISO 工具将iso写入SD卡中，然后开启U盘启动，安装ubuntu。<br>还需要通过 主板 BIOS开启 KVM，通过CPU设置开启 SVM:<br>如果不开启KVM直接用qemu开启 ubuntu虚拟机，效率比开启KVM虚拟机要慢 50倍左右，这也是我不想用 云服务器的原因。<br>换用<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/">清华源</a></p>
<h2 id="物理服务器安装qemu-ubuntu虚拟机"><a href="#物理服务器安装qemu-ubuntu虚拟机" class="headerlink" title="物理服务器安装qemu-ubuntu虚拟机"></a>物理服务器安装qemu-ubuntu虚拟机</h2><p>可以参考文章:<a target="_blank" rel="noopener" href="https://spyff.github.io/linux/2018/07/20/qemu-vm/">qemu起ubuntu server</a></p>
<p>在云服务器上按着文章成功配置了qemu虚拟机，但是在服务器上一直是失败的，原因就是起了服务器之后一直无法登陆。所以最后我用了桌面版本ubuntu 20.04.1，而不是 ubuntu server。</p>
<ol>
<li><p>下载 ubuntu iso</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu-releases&#x2F;20.04.1&#x2F;ubuntu-20.04.1-desktop-amd64.iso</span><br><span class="line">mv ubuntu-20.04.1-desktop-amd64.iso ubuntu.iso</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建磁盘</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -q -f qcow2 stable_ubuntu.img 32G</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装虚拟机<br>这一步尽量不要用 ssh做，直接在物理机器上搞比较快，第一次安装需要 -cdrom指定iso文件位置，后面就不需要了。在安装的之后需要指定 用户名密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装</span><br><span class="line">sudo qemu-system-x86_64 ubuntu.img -m 1024 -cdrom ubuntu.iso --enable-kvm</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动虚拟机<br>启动虚拟机分为两种:<br>a. 直接启动原来内核的虚拟机(可以直接联网，下载软件)<br>也可以ssh链接： ssh -v <a href="mailto:&#x72;&#x6c;&#x6b;&#x40;&#49;&#50;&#x37;&#46;&#48;&#x2e;&#x30;&#46;&#49;">&#x72;&#x6c;&#x6b;&#x40;&#49;&#50;&#x37;&#46;&#48;&#x2e;&#x30;&#46;&#49;</a> -p 2222</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-x86_64 \</span><br><span class="line">    -hda &#x2F;home&#x2F;ubuntu&#x2F;myspace&#x2F;qemu_build&#x2F;stable_ubuntu.img \</span><br><span class="line">    -smp 4 \</span><br><span class="line">    -m 4096 \</span><br><span class="line">    --enable-kvm \</span><br><span class="line">    -net nic \</span><br><span class="line">    -net user,hostfwd&#x3D;tcp::2222-:22 \</span><br><span class="line">    --nographic \</span><br><span class="line">    -fsdev local,id&#x3D;fs1,path&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share,security_model&#x3D;none \</span><br><span class="line">    -device virtio-9p-pci,fsdev&#x3D;fs1,mount_tag&#x3D;host_share</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>b. 用新kernel代替 stable_ubuntu.img中 的 kernel(替代内核)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-x86_64 \</span><br><span class="line">    -kernel &#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share&#x2F;stable&#x2F;bzImage \</span><br><span class="line">    -hda &#x2F;home&#x2F;ubuntu&#x2F;myspace&#x2F;qemu_build&#x2F;stable_ubuntu.img \</span><br><span class="line">    -append &quot;root&#x3D;&#x2F;dev&#x2F;sda5 console&#x3D;ttyS0&quot; \</span><br><span class="line">    -smp 4 \</span><br><span class="line">    -m 4096 \</span><br><span class="line">    --enable-kvm \</span><br><span class="line">    -net nic \</span><br><span class="line">    -net user,hostfwd&#x3D;tcp::2222-:22 \</span><br><span class="line">    --nographic \</span><br><span class="line">    -fsdev local,id&#x3D;fs1,path&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;workspace&#x2F;share,security_model&#x3D;none \</span><br><span class="line">    -device virtio-9p-pci,fsdev&#x3D;fs1,mount_tag&#x3D;host_share</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>至于开机启动都是 /etc/rc.local 里面配置<br><a target="_blank" rel="noopener" href="https://gitee.com/shshshsh/cloud_server_shell">https://gitee.com/shshshsh/cloud_server_shell</a></p>
</li>
<li><p>test 相关<br>a. ltp（linux kernel test project）：linux内核测试 project 编译安装，运行<br><a target="_blank" rel="noopener" href="https://github.com/linux-test-project/ltp">https://github.com/linux-test-project/ltp</a></p>
</li>
</ol>
<p>b. mmetst 可以测试 linux kernel 不同版本之间性能差异<br><a target="_blank" rel="noopener" href="https://github.com/gormanm/mmtests">https://github.com/gormanm/mmtests</a><br><a target="_blank" rel="noopener" href="https://lwn.net/Articles/820823/">https://lwn.net/Articles/820823/</a><br><a target="_blank" rel="noopener" href="https://lwn.net/Articles/463339/">https://lwn.net/Articles/463339/</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Linux_Everything/article/details/106485101">https://blog.csdn.net/Linux_Everything/article/details/106485101</a></p>
<p>c. lkp （linux kernel performance）:是 intel发起的一个kernel performance test项目<br><a target="_blank" rel="noopener" href="https://github.com/fengguang/lkp-">https://github.com/fengguang/lkp-</a><br><a target="_blank" rel="noopener" href="https://01.org/lkp">https://01.org/lkp</a><br><a target="_blank" rel="noopener" href="https://01.org/blogs/jdu1/2017/lkp-tests-linux-kernel-performance-test-and-analysis-tool">https://01.org/blogs/jdu1/2017/lkp-tests-linux-kernel-performance-test-and-analysis-tool</a><br><a target="_blank" rel="noopener" href="https://github.com/sammcj/kernel-ci">https://github.com/sammcj/kernel-ci</a><br><a target="_blank" rel="noopener" href="http://hejq.me/2014/10/30/lkp-tests-notes/">http://hejq.me/2014/10/30/lkp-tests-notes/</a><br><a target="_blank" rel="noopener" href="https://libraries.io/github/openthos/lkp-analysis">https://libraries.io/github/openthos/lkp-analysis</a></p>
<ol start="7">
<li>学习kvm<br><a target="_blank" rel="noopener" href="https://www.linux-kvm.org/page/Kvmtools">https://www.linux-kvm.org/page/Kvmtools</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/leoufung/article/details/48781119">https://blog.csdn.net/leoufung/article/details/48781119</a><br>git://git.kernel.org/pub/scm/linux/kernel/git/will/kvmtool.git</li>
</ol>
<h2 id="远程访问本地服务器"><a href="#远程访问本地服务器" class="headerlink" title="远程访问本地服务器"></a>远程访问本地服务器</h2><p>由于本地服务器其实是没有固定ip的，所以需要一台固定ip的服务器做中转，<br>这样才能从任何地方远程访问到我的物理服务器，正好有一个腾讯云服务器，就充当了这个角色。</p>
<p>我使用的是 nps 这个开源代理工具，相比于其他工具来说，配置简单，直接在网页上就可以配置<br>参考<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/102138783">超好用轻量级NPS内网穿透</a></p>
<h3 id="NPS问题"><a href="#NPS问题" class="headerlink" title="NPS问题"></a>NPS问题</h3><ol>
<li><p>稳定性：<br>这个我其实已经使用了超过1个月了，机器都没重启过，服务都还正常，对于个人使用来说完全足够了</p>
</li>
<li><p>带宽<br>由于我的腾讯云服务器带宽了 <code>1Mbps</code>,其实峰值带宽也就 <code>128Kb/s</code>。</p>
</li>
</ol>
<p>我使用服务器主要场景是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 有编译任务</span><br><span class="line">2. ssh 到服务器</span><br><span class="line">3. vscode ssh 到服务器看代码，写代码</span><br></pre></td></tr></table></figure>

<p>其实 1 和 2对 带宽要求都很低，但是 vscode ssh 对于带宽要求还是比较高的，<br>从腾讯云后台监控数据上看，我的服务器 每次都是 vscode ssh 到腾讯云的时候<br>或者服务器的时候带宽都用满了，导致有时候ssh需要连 几min 才能连接上。</p>
<p>vscode ssh 在连接上之后对于带宽使用率其实很低，在连接瞬间有较高要求。</p>
<p>我无奈之下就想给 腾讯云的服务搞成按流量计费的，一通操作下来没想到腾讯云居然不支持<br>活动时候买的服务器改网络配置。。</p>
<p>那就只能升级到2M带宽 或者更高了，升级了一下到 2Mbps,然后再用 vscode shh连接 就很丝滑了，然后我就想能不能通过调整vscode ssh配置来达到这样目的的，发现好像还真有个 timeout 时间，默认 <code>15s</code>，我改到了30s，也可能如果不升级带宽,仅仅将配置改到<code>30s</code> vscode经常超时的问题就好了呢？</p>
<p>等到5月份之后不续费再继续看看情况。。。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://liulangrenaaa.github.io/2020/12/12/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/docker%E4%B8%8Enamespace%E5%A6%82%E4%BD%95%E8%81%94%E7%B3%BB%E8%B5%B7%E6%9D%A5%E7%9A%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Hui">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liulangren Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/12/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/docker%E4%B8%8Enamespace%E5%A6%82%E4%BD%95%E8%81%94%E7%B3%BB%E8%B5%B7%E6%9D%A5%E7%9A%84/" class="post-title-link" itemprop="url">docker与cgroup如何联系起来的</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-12 14:47:40" itemprop="dateCreated datePublished" datetime="2020-12-12T14:47:40+08:00">2020-12-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-05 19:31:20" itemprop="dateModified" datetime="2020-12-05T19:31:20+08:00">2020-12-05</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>这篇文章主要实操看一看 Docker 与 Namespace 的联系。</p>
<ol>
<li><p>首先去 /sys/fs/cgroup/ 目录看一下当前支持的子系统controller，各个子系统controller下面一般情况下都是空的，表明系统中没有额外的cgroup，基本都只有root_cgroup.<br>虽然4.5版本之后 cgroup v2 就进入mainline了，但是 现在（2020.12.01）docker 基本还是在使用 cgroup v1, 应该也算是一个历史原因了吧，不知道何时 docker能迁移到 cgroup v2 上，期待ing</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# ls</span><br><span class="line">blkio  cpuacct      cpuset   freezer  memory   net_cls,net_prio  perf_event  rdma     unified</span><br><span class="line">cpu    cpu,cpuacct  devices  hugetlb  net_cls  net_prio          pids        systemd</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# mount | grep cgroup</span><br><span class="line">tmpfs on &#x2F;sys&#x2F;fs&#x2F;cgroup type tmpfs (ro,nosuid,nodev,noexec,mode&#x3D;755)</span><br><span class="line">cgroup2 on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;unified type cgroup2 (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,name&#x3D;systemd)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset,clone_children)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;rdma type cgroup (rw,nosuid,nodev,noexec,relatime,rdma)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls,net_prio)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)</span><br><span class="line">freezer on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;freezer type cgroup (rw,relatime,freezer)</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# ls memory</span><br><span class="line">cgroup.clone_children  memory.kmem.failcnt                 memory.limit_in_bytes            memory.usage_in_bytes</span><br><span class="line">cgroup.event_control   memory.kmem.limit_in_bytes          memory.max_usage_in_bytes        memory.use_hierarchy</span><br><span class="line">cgroup.procs           memory.kmem.max_usage_in_bytes      memory.move_charge_at_immigrate  notify_on_release</span><br><span class="line">cgroup.sane_behavior   memory.kmem.slabinfo                memory.numa_stat                 release_agent</span><br><span class="line">docker                 memory.kmem.tcp.failcnt             memory.oom_control               system.slice</span><br><span class="line">init.scope             memory.kmem.tcp.limit_in_bytes      memory.pressure_level            tasks</span><br><span class="line">machine.slice          memory.kmem.tcp.max_usage_in_bytes  memory.soft_limit_in_bytes       user</span><br><span class="line">memory.failcnt         memory.kmem.tcp.usage_in_bytes      memory.stat                      user.slice</span><br><span class="line">memory.force_empty     memory.kmem.usage_in_bytes          memory.swappiness</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# cat memory&#x2F;tasks</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">....</span><br><span class="line">1728692</span><br><span class="line">1731590</span><br></pre></td></tr></table></figure>
</li>
<li><p>基于 ubuntu image新建一个docker，限制memory 为 4MB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# sudo docker run -t -i -m 4MB ubuntu &#x2F;bin&#x2F;bash</span><br><span class="line">WARNING: Your kernel does not support swap limit capabilities or the cgroup is not mounted. Memory limited without swap.</span><br><span class="line">root@b3c618bb4df9:&#x2F;#</span><br></pre></td></tr></table></figure>
<p>警告可以忽略，可以看到docker的 id是 b3c618bb4df9。</p>
</li>
<li><p>可以发现各个子系统目录都会新建一个docker目录，且docker目录下有一个目录就是上面的docker container 的id。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory# ls</span><br><span class="line">cgroup.clone_children           memory.kmem.slabinfo                memory.soft_limit_in_bytes</span><br><span class="line">cgroup.event_control            memory.kmem.tcp.failcnt             memory.stat</span><br><span class="line">cgroup.procs                    memory.kmem.tcp.limit_in_bytes      memory.swappiness</span><br><span class="line">cgroup.sane_behavior            memory.kmem.tcp.max_usage_in_bytes  memory.usage_in_bytes</span><br><span class="line">docker                          memory.kmem.tcp.usage_in_bytes      memory.use_hierarchy</span><br><span class="line">init.scope                      memory.kmem.usage_in_bytes          notify_on_release</span><br><span class="line">machine.slice                   memory.limit_in_bytes               release_agent</span><br><span class="line">memory.failcnt                  memory.max_usage_in_bytes           system.slice</span><br><span class="line">memory.force_empty              memory.move_charge_at_immigrate     tasks</span><br><span class="line">memory.kmem.failcnt             memory.numa_stat                    user</span><br><span class="line">memory.kmem.limit_in_bytes      memory.oom_control                  user.slice</span><br><span class="line">memory.kmem.max_usage_in_bytes  memory.pressure_level</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory# ls docker</span><br><span class="line">1f3a24f9105950f6f463da0effa2465a518039c3bec76de71c6e20626dcfb286  memory.kmem.usage_in_bytes</span><br><span class="line">b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df  memory.limit_in_bytes</span><br><span class="line">cgroup.clone_children                                             memory.max_usage_in_bytes</span><br><span class="line">cgroup.event_control                                              memory.move_charge_at_immigrate</span><br><span class="line">cgroup.procs                                                      memory.numa_stat</span><br><span class="line">memory.failcnt                                                    memory.oom_control</span><br><span class="line">memory.force_empty                                                memory.pressure_level</span><br><span class="line">memory.kmem.failcnt                                               memory.soft_limit_in_bytes</span><br><span class="line">memory.kmem.limit_in_bytes                                        memory.stat</span><br><span class="line">memory.kmem.max_usage_in_bytes                                    memory.swappiness</span><br><span class="line">memory.kmem.slabinfo                                              memory.usage_in_bytes</span><br><span class="line">memory.kmem.tcp.failcnt                                           memory.use_hierarchy</span><br><span class="line">memory.kmem.tcp.limit_in_bytes                                    notify_on_release</span><br><span class="line">memory.kmem.tcp.max_usage_in_bytes                                tasks</span><br><span class="line">memory.kmem.tcp.usage_in_bytes</span><br></pre></td></tr></table></figure>
</li>
<li><p>其中 docker 目录下除了 container id的目录其他目录都是无效的，docker这个目录只是限制所有container id的一个顶层目录而已。通过 docker/tasks 为空就可以看出来。<br>可以看到 <code>memory/docker/b3c618bb4df9/</code> 目录下的最大内存限制，就是创建这个容器时设置的最大内存使用示4MB的限制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker# cat tasks</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker#</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat memory.limit_in_bytes</span><br><span class="line">4194304</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat tasks</span><br><span class="line">1733194</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# ps -aux | grep 17</span><br><span class="line">33194</span><br><span class="line">root     1733194  0.0  0.1   4108  3296 pts&#x2F;0    Ss+  19:03   0:00 &#x2F;bin&#x2F;bash</span><br><span class="line">ubuntu   1737657  0.0  0.0   6432   736 pts&#x2F;0    S+   19:11   0:00 grep --color&#x3D;auto --exclude-dir&#x3D;.bzr --exclude-dir&#x3D;CVS --exclude-dir&#x3D;.git --exclude-dir&#x3D;.hg --exclude-dir&#x3D;.svn --exclude-dir&#x3D;.idea --exclude-dir&#x3D;.tox tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# ps -aux | grep 17</span><br><span class="line">33194</span><br><span class="line">root     1733194  0.0  0.1   4108  3296 pts&#x2F;0    Ss+  19:03   0:00 &#x2F;bin&#x2F;bash</span><br><span class="line">ubuntu   1737657  0.0  0.0   6432   736 pts&#x2F;0    S+   19:11   0:00 grep --color&#x3D;auto --exclude-dir&#x3D;.bzr --exclude-dir&#x3D;CVS --exclude-dir&#x3D;.git --exclude-dir&#x3D;.hg --exclude-dir&#x3D;.svn --exclude-dir&#x3D;.idea --exclude-dir&#x3D;.tox 1733194</span><br></pre></td></tr></table></figure>
<p>可以看到这个 <code>1733194</code> 进程就是启动 容器时的 /bin/bash 进程</p>
</li>
<li><p>由于其他的 cgroup子系统我们没有对刚刚启动的 container 进行限制，所以也理论上从 cgroup上看到的也是没有限制的，可以看看 cpu controller.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker# cat tasks</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker# cd -</span><br><span class="line">&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat tasks</span><br><span class="line">1733194</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat cpu.cfs_period_us</span><br><span class="line">100000</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat cpu.cfs_quota_us</span><br><span class="line">-1</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>这里就不具体介绍 各个子系统目录下文件含义了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://liulangrenaaa.github.io/2020/12/12/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/docker%E4%B8%8Ecgroup%E5%A6%82%E4%BD%95%E8%81%94%E7%B3%BB%E8%B5%B7%E6%9D%A5%E7%9A%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Hui">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liulangren Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/12/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/docker%E4%B8%8Ecgroup%E5%A6%82%E4%BD%95%E8%81%94%E7%B3%BB%E8%B5%B7%E6%9D%A5%E7%9A%84/" class="post-title-link" itemprop="url">docker与cgroup如何联系起来的</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-12 14:47:40" itemprop="dateCreated datePublished" datetime="2020-12-12T14:47:40+08:00">2020-12-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-05 19:21:23" itemprop="dateModified" datetime="2020-12-05T19:21:23+08:00">2020-12-05</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>一直说Docker 是基于linux三大技术 Cgroups, Namespace, OverlayFs 技术。<br>Cgroups, Namespace 着重的是 docker 的运行时，OverlayFs 着重的是 docker Image.<br>但是Docker 与 Cgroups, Namespace, OverlayFs 是怎么联系起来的呢，却很少有人说的明白，<br>我是一个好奇心很重的人，我会用几篇文章来记录分析一下他们怎么练习起来的。</p>
<p>这篇文章主要实操看一看 Docker 与 Cgroup 的联系。</p>
<ol>
<li><p>首先去 /sys/fs/cgroup/ 目录看一下当前支持的子系统controller，各个子系统controller下面一般情况下都是空的，表明系统中没有额外的cgroup，基本都只有root_cgroup.<br>虽然4.5版本之后 cgroup v2 就进入mainline了，但是 现在（2020.12.01）docker 基本还是在使用 cgroup v1, 应该也算是一个历史原因了吧，不知道何时 docker能迁移到 cgroup v2 上，期待ing</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# ls</span><br><span class="line">blkio  cpuacct      cpuset   freezer  memory   net_cls,net_prio  perf_event  rdma     unified</span><br><span class="line">cpu    cpu,cpuacct  devices  hugetlb  net_cls  net_prio          pids        systemd</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# mount | grep cgroup</span><br><span class="line">tmpfs on &#x2F;sys&#x2F;fs&#x2F;cgroup type tmpfs (ro,nosuid,nodev,noexec,mode&#x3D;755)</span><br><span class="line">cgroup2 on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;unified type cgroup2 (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,name&#x3D;systemd)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset,clone_children)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;rdma type cgroup (rw,nosuid,nodev,noexec,relatime,rdma)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls,net_prio)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)</span><br><span class="line">freezer on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;freezer type cgroup (rw,relatime,freezer)</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# ls memory</span><br><span class="line">cgroup.clone_children  memory.kmem.failcnt                 memory.limit_in_bytes            memory.usage_in_bytes</span><br><span class="line">cgroup.event_control   memory.kmem.limit_in_bytes          memory.max_usage_in_bytes        memory.use_hierarchy</span><br><span class="line">cgroup.procs           memory.kmem.max_usage_in_bytes      memory.move_charge_at_immigrate  notify_on_release</span><br><span class="line">cgroup.sane_behavior   memory.kmem.slabinfo                memory.numa_stat                 release_agent</span><br><span class="line">docker                 memory.kmem.tcp.failcnt             memory.oom_control               system.slice</span><br><span class="line">init.scope             memory.kmem.tcp.limit_in_bytes      memory.pressure_level            tasks</span><br><span class="line">machine.slice          memory.kmem.tcp.max_usage_in_bytes  memory.soft_limit_in_bytes       user</span><br><span class="line">memory.failcnt         memory.kmem.tcp.usage_in_bytes      memory.stat                      user.slice</span><br><span class="line">memory.force_empty     memory.kmem.usage_in_bytes          memory.swappiness</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# cat memory&#x2F;tasks</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">....</span><br><span class="line">1728692</span><br><span class="line">1731590</span><br></pre></td></tr></table></figure>
</li>
<li><p>基于 ubuntu image新建一个docker，限制memory 为 4MB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup# sudo docker run -t -i -m 4MB ubuntu &#x2F;bin&#x2F;bash</span><br><span class="line">WARNING: Your kernel does not support swap limit capabilities or the cgroup is not mounted. Memory limited without swap.</span><br><span class="line">root@b3c618bb4df9:&#x2F;#</span><br></pre></td></tr></table></figure>
<p>警告可以忽略，可以看到docker的 id是 b3c618bb4df9。</p>
</li>
<li><p>可以发现各个子系统目录都会新建一个docker目录，且docker目录下有一个目录就是上面的docker container 的id。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory# ls</span><br><span class="line">cgroup.clone_children           memory.kmem.slabinfo                memory.soft_limit_in_bytes</span><br><span class="line">cgroup.event_control            memory.kmem.tcp.failcnt             memory.stat</span><br><span class="line">cgroup.procs                    memory.kmem.tcp.limit_in_bytes      memory.swappiness</span><br><span class="line">cgroup.sane_behavior            memory.kmem.tcp.max_usage_in_bytes  memory.usage_in_bytes</span><br><span class="line">docker                          memory.kmem.tcp.usage_in_bytes      memory.use_hierarchy</span><br><span class="line">init.scope                      memory.kmem.usage_in_bytes          notify_on_release</span><br><span class="line">machine.slice                   memory.limit_in_bytes               release_agent</span><br><span class="line">memory.failcnt                  memory.max_usage_in_bytes           system.slice</span><br><span class="line">memory.force_empty              memory.move_charge_at_immigrate     tasks</span><br><span class="line">memory.kmem.failcnt             memory.numa_stat                    user</span><br><span class="line">memory.kmem.limit_in_bytes      memory.oom_control                  user.slice</span><br><span class="line">memory.kmem.max_usage_in_bytes  memory.pressure_level</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory# ls docker</span><br><span class="line">1f3a24f9105950f6f463da0effa2465a518039c3bec76de71c6e20626dcfb286  memory.kmem.usage_in_bytes</span><br><span class="line">b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df  memory.limit_in_bytes</span><br><span class="line">cgroup.clone_children                                             memory.max_usage_in_bytes</span><br><span class="line">cgroup.event_control                                              memory.move_charge_at_immigrate</span><br><span class="line">cgroup.procs                                                      memory.numa_stat</span><br><span class="line">memory.failcnt                                                    memory.oom_control</span><br><span class="line">memory.force_empty                                                memory.pressure_level</span><br><span class="line">memory.kmem.failcnt                                               memory.soft_limit_in_bytes</span><br><span class="line">memory.kmem.limit_in_bytes                                        memory.stat</span><br><span class="line">memory.kmem.max_usage_in_bytes                                    memory.swappiness</span><br><span class="line">memory.kmem.slabinfo                                              memory.usage_in_bytes</span><br><span class="line">memory.kmem.tcp.failcnt                                           memory.use_hierarchy</span><br><span class="line">memory.kmem.tcp.limit_in_bytes                                    notify_on_release</span><br><span class="line">memory.kmem.tcp.max_usage_in_bytes                                tasks</span><br><span class="line">memory.kmem.tcp.usage_in_bytes</span><br></pre></td></tr></table></figure>
</li>
<li><p>其中 docker 目录下除了 container id的目录其他目录都是无效的，docker这个目录只是限制所有container id的一个顶层目录而已。通过 docker/tasks 为空就可以看出来。<br>可以看到 <code>memory/docker/b3c618bb4df9/</code> 目录下的最大内存限制，就是创建这个容器时设置的最大内存使用示4MB的限制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker# cat tasks</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker#</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat memory.limit_in_bytes</span><br><span class="line">4194304</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat tasks</span><br><span class="line">1733194</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# ps -aux | grep 17</span><br><span class="line">33194</span><br><span class="line">root     1733194  0.0  0.1   4108  3296 pts&#x2F;0    Ss+  19:03   0:00 &#x2F;bin&#x2F;bash</span><br><span class="line">ubuntu   1737657  0.0  0.0   6432   736 pts&#x2F;0    S+   19:11   0:00 grep --color&#x3D;auto --exclude-dir&#x3D;.bzr --exclude-dir&#x3D;CVS --exclude-dir&#x3D;.git --exclude-dir&#x3D;.hg --exclude-dir&#x3D;.svn --exclude-dir&#x3D;.idea --exclude-dir&#x3D;.tox tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# ps -aux | grep 17</span><br><span class="line">33194</span><br><span class="line">root     1733194  0.0  0.1   4108  3296 pts&#x2F;0    Ss+  19:03   0:00 &#x2F;bin&#x2F;bash</span><br><span class="line">ubuntu   1737657  0.0  0.0   6432   736 pts&#x2F;0    S+   19:11   0:00 grep --color&#x3D;auto --exclude-dir&#x3D;.bzr --exclude-dir&#x3D;CVS --exclude-dir&#x3D;.git --exclude-dir&#x3D;.hg --exclude-dir&#x3D;.svn --exclude-dir&#x3D;.idea --exclude-dir&#x3D;.tox 1733194</span><br></pre></td></tr></table></figure>
<p>可以看到这个 <code>1733194</code> 进程就是启动 容器时的 /bin/bash 进程</p>
</li>
<li><p>由于其他的 cgroup子系统我们没有对刚刚启动的 container 进行限制，所以也理论上从 cgroup上看到的也是没有限制的，可以看看 cpu controller.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker# cat tasks</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker# cd -</span><br><span class="line">&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat tasks</span><br><span class="line">1733194</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat cpu.cfs_period_us</span><br><span class="line">100000</span><br><span class="line">tencent_clould@ubuntu: &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu&#x2F;docker&#x2F;b3c618bb4df96362b371860f84e5de5248339c9675e4eac7fd7fee6ebb5602df# cat cpu.cfs_quota_us</span><br><span class="line">-1</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>这里就不具体介绍 各个子系统目录下文件含义了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://liulangrenaaa.github.io/2020/12/01/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/docker%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Hui">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liulangren Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/01/Docker%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/docker%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">docker如何使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-01 14:47:40" itemprop="dateCreated datePublished" datetime="2020-12-01T14:47:40+08:00">2020-12-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-05 18:46:17" itemprop="dateModified" datetime="2020-12-05T18:46:17+08:00">2020-12-05</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>这是一个简单概括docker 安装，拉取image,docker 命令使用的 记录。</p>
<ol>
<li><p>在ubuntu平台上安装 docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>拉取ubuntu的 image</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull ubuntu</span><br></pre></td></tr></table></figure>
</li>
<li><p>基于ubuntu的 image 创建并运行一个docker，限制4MB内存，开启 bash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -t -i -m 4MB ubuntu &#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看当前有哪些运行的docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace# sudo docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">1f3a24f91059        ubuntu              &quot;&#x2F;bin&#x2F;bash&quot;         47 hours ago        Up 47 hours                             hhhh</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看当前有哪些的docker(运行中 + 非运行中)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace# sudo docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">1f3a24f91059        ubuntu              &quot;&#x2F;bin&#x2F;bash&quot;         47 hours ago        Up 47 hours                             hhhhh</span><br></pre></td></tr></table></figure>
</li>
<li><p>给 hhh 的容器重命名为 my_ubuntu</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rename  hhh my_ubuntu</span><br></pre></td></tr></table></figure>
</li>
<li><p>停止 my_ubuntu 容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stop my_ubuntu</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启开启 my_ubuntu 容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker start my_ubuntu</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入运行中的 my_ubuntu 容器的 bash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker exec -ti my_ubuntu &#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>


</li>
</ol>
<p>其他常用命令想起来再记录</p>
<p>这些命令还是比较长的，可以缩写到 bashrc 的alias里面，比较方便</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tencent_clould@ubuntu: ~&#x2F;workspace# cat ~&#x2F;.zshrc | grep &quot;alias d&quot;</span><br><span class="line">alias dn&#x3D;&quot;sudo docker run -t -i -m 128MB ubuntu &#x2F;bin&#x2F;bash&quot;</span><br><span class="line">alias ds&#x3D;&quot;sudo docker start my_ubuntu&quot;</span><br><span class="line">alias dk&#x3D;&quot;sudo docker stop my_ubuntu&quot;</span><br><span class="line">alias di&#x3D;&quot;sudo docker exec -ti my_ubuntu &#x2F;bin&#x2F;bash&quot;</span><br><span class="line">alias dps&#x3D;&quot;sudo docker ps&quot;</span><br><span class="line">alias dpsa&#x3D;&quot;sudo docker ps -a&quot;</span><br><span class="line">alias drma&#x3D;&quot;sudo  docker container prune&quot;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://liulangrenaaa.github.io/2020/09/22/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/%E8%AE%B0%E5%BD%95%E7%AC%AC%E4%B8%80%E4%B8%AAkernel%20patch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Hui">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liulangren Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/%E8%AE%B0%E5%BD%95%E7%AC%AC%E4%B8%80%E4%B8%AAkernel%20patch/" class="post-title-link" itemprop="url">记录第一个kernel patch</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-09-22 23:00:00" itemprop="dateCreated datePublished" datetime="2020-09-22T23:00:00+08:00">2020-09-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-10-21 23:43:50" itemprop="dateModified" datetime="2020-10-21T23:43:50+08:00">2020-10-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/" itemprop="url" rel="index"><span itemprop="name">生活感悟</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>之前也提过两个patch给社区不过都被否了，很多大佬第一次提patch也是从改改标点开始的。<br>最近在看文件系统相关的代码，看到有个地方定义和注释不一致，可以给社区贡献一下，也顺便记录一下，搭建环境的过程（之前用的ubuntu18虚拟机被我删了…现在用ubuntu20重新搞一下）</p>
<h2 id="修改代码，形成patch"><a href="#修改代码，形成patch" class="headerlink" title="修改代码，形成patch"></a>修改代码，形成patch</h2><p>其实我这个patch很简单，只是修改一个注释而已：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ git diff</span><br><span class="line">diff --git a&#x2F;include&#x2F;linux&#x2F;jbd2.h b&#x2F;include&#x2F;linux&#x2F;jbd2.h</span><br><span class="line">index 08f904943ab2..a1ef05412acf 100644</span><br><span class="line">--- a&#x2F;include&#x2F;linux&#x2F;jbd2.h</span><br><span class="line">+++ b&#x2F;include&#x2F;linux&#x2F;jbd2.h</span><br><span class="line">@@ -452,8 +452,8 @@ struct jbd2_inode &#123;</span><br><span class="line"> struct jbd2_revoke_table_s;</span><br><span class="line"> </span><br><span class="line"> &#x2F;**</span><br><span class="line">- * struct handle_s - The handle_s type is the concrete type associated with</span><br><span class="line">- *     handle_t.</span><br><span class="line">+ * struct jbd2_journal_handle - The jbd2_journal_handle type is the concrete</span><br><span class="line">+ *     type associated with handle_t.</span><br><span class="line">  * @h_transaction: Which compound transaction is this update a part of?</span><br><span class="line">  * @h_journal: Which journal handle belongs to - used iff h_reserved set.</span><br><span class="line">  * @h_rsv_handle: Handle reserved for finishing the logical operation.</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ </span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ git log -1</span><br><span class="line">commit f8db1794205285c44d4b0b7d83f0fda1b9adec00 (HEAD -&gt; master)</span><br><span class="line">Author: Hui Su &lt;sh_def@163.com&gt;</span><br><span class="line">Date:   Tue Sep 22 23:28:05 2020 +0800</span><br><span class="line"></span><br><span class="line">    FIX the comment of struct jbd2_journal_handle</span><br><span class="line">    </span><br><span class="line">    the struct name was modified long ago, but the comment still</span><br><span class="line">    use struct handle_s.</span><br><span class="line">    </span><br><span class="line">    Signed-off-by: Hui Su &lt;sh_def@163.com&gt;</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ git format-patch HEAD^</span><br><span class="line">0001-FIX-the-comment-of-struct-jbd2_journal_handle.patch</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$</span><br></pre></td></tr></table></figure>

<p>如果第一个版本有问题则需要重新提第二个版本patch，与第一个版本差别就是加上 ‘ -v2’<br> ‘ -v3’ 等，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux-stable$ git format-patch HEAD^ -v2</span><br><span class="line">v2-0001-tools-time-access-sys-kernel-debug-udelay_test-be.patch</span><br></pre></td></tr></table></figure>
<p>在邮件发出之后会自动变成<br>[PATCH v2] tools/time: access /sys/kernel/debug/udelay_test before test</p>
<p>如果不是一个patch，而是一系列patch怎么办呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">肯定是有办法的，目前我还没这个需求，留白，后续补充</span><br><span class="line">lkml中的邮件格式：</span><br><span class="line">[PATCH v6 00&#x2F;25] Add support for Clang LTO</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/section/1138664">git format-patch</a></p>
<h2 id="找到修改代码部分的maintainer"><a href="#找到修改代码部分的maintainer" class="headerlink" title="找到修改代码部分的maintainer"></a>找到修改代码部分的maintainer</h2><ol>
<li>先用 <code>perl scripts/checkpatch.pl</code> 检查patch有无语法错误</li>
<li>再用 <code>perl scripts/get_maintainer.pl</code> 获取patch修改的代码的 maintainer<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ perl scripts&#x2F;checkpatch.pl  0001-FIX-the-comment-of-struct-jbd2_journal_handle.patch </span><br><span class="line">total: 0 errors, 0 warnings, 10 lines checked</span><br><span class="line"></span><br><span class="line">0001-FIX-the-comment-of-struct-jbd2_journal_handle.patch has no obvious style problems and is ready for submission.</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ </span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$ perl scripts&#x2F;get_maintainer.pl  0001-FIX-the-comment-of-struct-jbd2_journal_handle.patch </span><br><span class="line">&quot;Theodore Ts&#39;o&quot; &lt;tytso@mit.edu&gt; (maintainer:JOURNALLING LAYER FOR BLOCK DEVICES (JBD2))</span><br><span class="line">Jan Kara &lt;jack@suse.com&gt; (maintainer:JOURNALLING LAYER FOR BLOCK DEVICES (JBD2))</span><br><span class="line">linux-ext4@vger.kernel.org (open list:JOURNALLING LAYER FOR BLOCK DEVICES (JBD2))</span><br><span class="line">linux-kernel@vger.kernel.org (open list)</span><br><span class="line">sh@ubuntu:~&#x2F;workspace&#x2F;linux$</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="安装配置邮件客户端"><a href="#安装配置邮件客户端" class="headerlink" title="安装配置邮件客户端"></a>安装配置邮件客户端</h2><p>安装下面工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install sendmail</span><br><span class="line">sudo apt  install mutt</span><br><span class="line">sudo apt install smtp</span><br></pre></td></tr></table></figure>

<p>配置一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~$ cat .muttrc </span><br><span class="line">set sendmail&#x3D;&quot;&#x2F;usr&#x2F;bin&#x2F;msmtp&quot;</span><br><span class="line">set envelope_from&#x3D;yes</span><br><span class="line">set realname&#x3D;&quot;Hui Su&quot;</span><br><span class="line">set from&#x3D;sh_def@163.com</span><br><span class="line">set use_from&#x3D;yes</span><br><span class="line">set envelope_from&#x3D;yes</span><br><span class="line">sh@ubuntu:~$ </span><br><span class="line">sh@ubuntu:~$ </span><br><span class="line">sh@ubuntu:~$ </span><br><span class="line">sh@ubuntu:~$ cat .msmtprc </span><br><span class="line">account default</span><br><span class="line">host smtp.163.com</span><br><span class="line">port 25</span><br><span class="line">from sh_def@163.com</span><br><span class="line">auth plain</span><br><span class="line">tls off</span><br><span class="line">user sh_def@163.com</span><br><span class="line">password #这里填授权码</span><br><span class="line">sh@ubuntu:~$ </span><br></pre></td></tr></table></figure>

<p>测试一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~$ echo &quot;test&quot; |mutt -s &quot;my_first_test&quot; xxx@163.com</span><br><span class="line">sh@ubuntu:~$ echo &quot;test&quot; |mutt -s &quot;my_first_test&quot; xxxx@qq.com</span><br></pre></td></tr></table></figure>
<p>吐槽一下，如果是第一次配置还是比较难搞的<br>参考<a target="_blank" rel="noopener" href="https://learnku.com/articles/13307/mutt-mail-sending">参考</a></p>
<h2 id="git-配置"><a href="#git-配置" class="headerlink" title="git 配置"></a>git 配置</h2><p>这个应该在 git commit 阶段就已经配置好了，不赘述</p>
<h2 id="推送patch"><a href="#推送patch" class="headerlink" title="推送patch"></a>推送patch</h2><p>只需要在各个邮箱之间加上,即可，不赘述</p>
<h2 id="回复邮件"><a href="#回复邮件" class="headerlink" title="回复邮件"></a>回复邮件</h2><p>一般情况下社区大佬都会在几天到一周内回复你的patch邮件，如果你的patch需要修改，<br>然后你需要重新回复他们的邮件，这应该如何做呢</p>
<ol>
<li><p>第一步配置好fetchmail</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu:~$ sudo apt install fetchmail </span><br><span class="line">[sudo] password for rlk: </span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree       </span><br><span class="line">Reading state information... Done</span><br><span class="line">fetchmail is already the newest version (6.4.2-2).</span><br><span class="line">0 upgraded, 0 newly installed, 0 to remove and 369 not upgraded.</span><br><span class="line">sh@ubuntu:~$ cat ~&#x2F;.fetchmailrc </span><br><span class="line">poll pop3.163.com</span><br><span class="line">protocol POP3</span><br><span class="line">user &quot;xxx@163.com&quot; </span><br><span class="line">password &quot;客户端授权码&quot;</span><br><span class="line">sh@ubuntu:~$ ll | grep rc | grep fetch</span><br><span class="line">-rwx------  1 rlk  rlk       83 10月  8 01:38 .fetchmailrc*</span><br><span class="line"></span><br><span class="line"># 接收邮件</span><br><span class="line">sh@ubuntu:~$ fetchmail  -v</span><br><span class="line">fetchmail: 6.4.2 querying pop3.163.com (protocol POP3) at 2020年10月08日 星期四 01时38分51秒: poll started</span><br><span class="line">Trying to connect to 220.181.12.110&#x2F;110...connected.</span><br><span class="line">fetchmail: POP3&lt; +OK Welcome to coremail Mail Pop3 Server (163coms[10774b260cc7a37d26d71b52404dcf5cs])</span><br><span class="line">fetchmail: POP3&gt; CAPA</span><br><span class="line">fetchmail: POP3&lt; +OK Capability list follows</span><br><span class="line">...............</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看接收的邮件<br>然后直接 mutt 就可以看到接收到的邮件了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">q:Quit  d:Del  u:Undel  s:Save  m:Mail  r:Reply  g:Group  ?:Help</span><br><span class="line">   1 O + 9月 09 iovisor-dev@lis ( 378) [iovisor-dev] iovisor-dev@lists.iovisor.org Daily Summary</span><br><span class="line">   2   + 9月 22 Mail Delivery S (  50) Returned mail: see transcript for details</span><br><span class="line">   3   + 9月 22 Mail Delivery S (  50) Returned mail: see transcript for details</span><br><span class="line">   4 O F 9月 23 To sh_def@163.c (  75) [PATCH] mm,page_alloc: fix the count of free pages</span><br><span class="line">   5 O T 9月 23 Jan Kara        (  38) ┬─&gt;Re: [PATCH] FIX the comment of struct jbd2_journal_handle</span><br><span class="line">   6 O T 10月 03 Theodore Y. Ts&#39; (  11) └─&gt;Re: [PATCH] FIX the comment of struct jbd2_journal_handle</span><br><span class="line">   7 O + 9月 25 Josh Poimboeuf  (   3) ┬─&gt;Re: [PATCH] mm,kmemleak-test.c: move kmemleak-test.c to samples dir</span><br><span class="line">   8 O T 10月 05 Catalin Marinas (  12) └─&gt;Re: [PATCH] mm,kmemleak-test.c: move kmemleak-test.c to samples dir</span><br><span class="line">   9 O T 9月 25 akpm@linux-foun ( 313) + mmkmemleak-testc-move-kmemleak-testc-to-samples-dir.patch added to -mm tree</span><br><span class="line">  10 O T 9月 25 akpm@linux-foun (  92) + mm-fix-some-comments-in-page_allocc-and-mempolicyc.patch added to -mm tree</span><br><span class="line">  11 O T 9月 28 Ira Weiny       (  57) Re: [PATCH] mm&#x2F;vmalloc.c: check the addr first</span><br><span class="line">  12 O T 9月 28 akpm@linux-foun (  56) + mm-vmscan-fix-comments-for-isolate_lru_page.patch added to -mm tree</span><br><span class="line">  13 O T 9月 28 akpm@linux-foun (  59) + mm-vmallocc-update-the-comment-in-__vmalloc_area_node.patch added to -mm tree</span><br><span class="line">  14 O T 9月 28 akpm@linux-foun (  66) + mm-vmallocc-fix-the-comment-of-find_vm_area.patch added to -mm tree</span><br><span class="line">  15 O T 9月 28 akpm@linux-foun (  65) + mmz3fold-use-xx_zalloc-instead-xx_alloc-and-memset.patch added to -mm tree</span><br><span class="line">  16 O + 9月 29 haifei.wang@car ( 312) 阿里云&#x2F;今日头条Linux内核研发专家职位推荐</span><br><span class="line">  17 O T 9月 29 Dietmar Eggeman (  59) Re: [PATCH] sched,fair: use list_for_each_entry() in print_cfs_stats()</span><br><span class="line">  18 O + 9月 29 iovisor-dev@lis ( 378) [iovisor-dev] iovisor-dev@lists.iovisor.org Daily Summary</span><br><span class="line">  19 O T 9月 29 Steven Rostedt  (  61) Re: [PATCH] sched&#x2F;rt.c remove unnecessary parameter in pick_next_rt_entity</span><br><span class="line">  20 O T 9月 30 boris.ostrovsky (  13) Re: [PATCH] arch&#x2F;x86: fix some typos in xen_pagetable_p2m_free()</span><br><span class="line">  21 O T 10月 01 David Hildenbra (  57) Re: [PATCH] mm: fix some comments in page_alloc.c and mempolicy.c</span><br><span class="line">  22 O T 10月 01 Joe Perches     (  14) └─&gt;</span><br><span class="line">  23 O + 10月 01 iovisor-dev@lis ( 378) [iovisor-dev] iovisor-dev@lists.iovisor.org Daily Summary</span><br><span class="line">  24 O   10月 02 George Worden   (   1)</span><br><span class="line">  25 O T 10月 02 akpm@linux-foun (  81) [to-be-updated] mm-fix-some-comments-in-page_allocc-and-mempolicyc.patch removed from -mm tree</span><br><span class="line">  26 O + 10月 08 流浪人          (  75) Re:[PATCH] mm&#x2F;hugetlb.c: just use put_page_testzero() instead of page_count()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---Mutt: &#x2F;var&#x2F;mail&#x2F;rlk [Msgs:26 Old:24 Post:8 174K]---(threads&#x2F;date)---------------------------------------------------------------------------------------------------------------------------------(all)--</span><br></pre></td></tr></table></figure>
</li>
<li><p>回复邮件<br><a target="_blank" rel="noopener" href="https://lkml.org/lkml/2020/9/22/824">我的第一个patch</a></p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://liulangrenaaa.github.io/2020/09/21/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/%E5%85%B3%E4%BA%8Epreempt_count%E7%9A%84%E6%80%9D%E8%80%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Hui">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liulangren Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/21/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/%E5%85%B3%E4%BA%8Epreempt_count%E7%9A%84%E6%80%9D%E8%80%83/" class="post-title-link" itemprop="url">关于preempt_count的思考</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2020-09-21 14:47:40 / Modified: 02:36:50" itemprop="dateCreated datePublished" datetime="2020-09-21T14:47:40+08:00">2020-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">linux内核</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>preempt_conut 本质就是一个int型的数，是每个 <code>task_struct</code> 的 <code>thread_info</code> 的一个成员变量，但是他和系统的调度密切相关，当然也十分重要。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct thread_info &#123;</span><br><span class="line">	unsigned long		flags;		&#x2F;* low level flags *&#x2F;</span><br><span class="line">	int			preempt_count;	&#x2F;* 0 &#x3D;&gt; preemptable, &lt;0 &#x3D;&gt; bug *&#x2F;</span><br><span class="line">    .......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在 <code>inlcude/linux/preempt.h</code> 文件看相关定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">static __always_inline int preempt_count(void)</span><br><span class="line">&#123;</span><br><span class="line">	return READ_ONCE(current_thread_info()-&gt;preempt_count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"> *         PREEMPT_MASK:	0x000000ff</span><br><span class="line"> *         SOFTIRQ_MASK:	0x0000ff00</span><br><span class="line"> *         HARDIRQ_MASK:	0x000f0000</span><br><span class="line"> *             NMI_MASK:	0x00100000</span><br><span class="line"> * PREEMPT_NEED_RESCHED:	0x80000000</span><br><span class="line"> *&#x2F;</span><br><span class="line">#define PREEMPT_BITS	8</span><br><span class="line">#define SOFTIRQ_BITS	8</span><br><span class="line">#define HARDIRQ_BITS	4</span><br><span class="line">#define NMI_BITS	1</span><br><span class="line"></span><br><span class="line">#define PREEMPT_SHIFT	0</span><br><span class="line">#define SOFTIRQ_SHIFT	(PREEMPT_SHIFT + PREEMPT_BITS)</span><br><span class="line">#define HARDIRQ_SHIFT	(SOFTIRQ_SHIFT + SOFTIRQ_BITS)</span><br><span class="line">#define NMI_SHIFT	(HARDIRQ_SHIFT + HARDIRQ_BITS)</span><br><span class="line"></span><br><span class="line">#define hardirq_count()	(preempt_count() &amp; HARDIRQ_MASK)</span><br><span class="line">#define softirq_count()	(preempt_count() &amp; SOFTIRQ_MASK)</span><br><span class="line">#define irq_count()	(preempt_count() &amp; (HARDIRQ_MASK | SOFTIRQ_MASK \</span><br><span class="line">				 | NMI_MASK))</span><br><span class="line"></span><br><span class="line">#define in_irq()		(hardirq_count())</span><br><span class="line">#define in_softirq()		(softirq_count())</span><br><span class="line">#define in_interrupt()		(irq _count())</span><br><span class="line">#define in_serving_softirq()	(softirq_count() &amp; SOFTIRQ_OFFSET)</span><br><span class="line">#define in_nmi()		(preempt_count() &amp; NMI_MASK)</span><br><span class="line">#define in_task()		(!(preempt_count() &amp; \</span><br><span class="line">				   (NMI_MASK | HARDIRQ_MASK | SOFTIRQ_OFFSET)))</span><br></pre></td></tr></table></figure>

<p>可以看出 <code>preempt_count</code> 0-7 bit被用来抢占计数，8-15 bit被用来软中断计数，16-19 bit被用来硬件中断计数，20bit 被用来 NMI中断计数，31 bit被用来记录是否需要立即sched.</p>
<p>in_interrupt() 这些宏本质也是根据 preempt_count()来判断的。</p>
<h2 id="hard-irq"><a href="#hard-irq" class="headerlink" title="hard irq"></a>hard irq</h2><p>在进入irq的时候通过 <code>irq_enter</code> 将preempt_count 的 16-19bit ++，在退出irq的时候通过 <code>irq_exit</code> 将preempt_count 的 16-19bit –，但是由于目前linux中的中断往往是不可嵌套的，所以一般 hardirq 只会用到 16 bit，为什么linux给 hardirq 保留了4bit呢，這是歷史原因造成的，早期hardirq还是可以嵌套的。</p>
<p>irq_enter()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#define preempt_count_add(val)	__preempt_count_add(val)</span><br><span class="line"></span><br><span class="line">#define __irq_enter()					\</span><br><span class="line">	do &#123;						\</span><br><span class="line">		account_irq_enter_time(current);	\</span><br><span class="line">		preempt_count_add(HARDIRQ_OFFSET);	\  &#x2F;&#x2F; preempt_count 和 hardirq相关++</span><br><span class="line">		trace_hardirq_enter();			\</span><br><span class="line">	&#125; while (0)</span><br><span class="line"></span><br><span class="line">void irq_enter(void) &#x2F;&#x2F;进入中断上下文</span><br><span class="line">&#123;</span><br><span class="line">	rcu_irq_enter();</span><br><span class="line">	if (is_idle_task(current) &amp;&amp; !in_interrupt()) &#123;</span><br><span class="line">		&#x2F;*</span><br><span class="line">		 * Prevent raise_softirq from needlessly waking up ksoftirqd</span><br><span class="line">		 * here, as softirq will be serviced on return from interrupt.</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		local_bh_disable();</span><br><span class="line">		tick_irq_enter();</span><br><span class="line">		_local_bh_enable();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	__irq_enter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>irq_exit()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#define preempt_count_sub(val)	__preempt_count_sub(val)</span><br><span class="line"></span><br><span class="line">void irq_exit(void) &#x2F;&#x2F;退出中断上下文</span><br><span class="line">&#123;</span><br><span class="line">#ifndef __ARCH_IRQ_EXIT_IRQS_DISABLED</span><br><span class="line">	local_irq_disable();</span><br><span class="line">#else</span><br><span class="line">	lockdep_assert_irqs_disabled();</span><br><span class="line">#endif</span><br><span class="line">	account_irq_exit_time(current);</span><br><span class="line">	preempt_count_sub(HARDIRQ_OFFSET); &#x2F;&#x2F; preempt_count 和 hardirq相关--</span><br><span class="line">	if (!in_interrupt() &amp;&amp; local_softirq_pending())</span><br><span class="line">		invoke_softirq();</span><br><span class="line"></span><br><span class="line">	tick_irq_exit();</span><br><span class="line">	rcu_irq_exit();</span><br><span class="line">	trace_hardirq_exit(); &#x2F;* must be last! *&#x2F;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="soft-irq"><a href="#soft-irq" class="headerlink" title="soft irq"></a>soft irq</h2><p>preempt_count中的第8到15个bit表示softirq count，它记录了进入softirq的嵌套次数，如果softirq count的值为正数，说明现在正处于softirq上下文中。<br>由于softirq在单个CPU上是不会嵌套执行的，因此和hardirq count一样，实际只需要一个bit(bit 8)就可以了。<br>还有一种情况，softirq count 会用到不止 bit8，在禁用中断下半部的情况下，每禁用一次softirq count 就会增加1，理论上最多可以嵌套16次。</p>
<p>进入退出软中断的case</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">asmlinkage __visible void __softirq_entry __do_softirq(void)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">	__local_bh_disable_ip(_RET_IP_, SOFTIRQ_OFFSET);</span><br><span class="line">    ......</span><br><span class="line">	while ((softirq_bit &#x3D; ffs(pending))) &#123;</span><br><span class="line">        ......</span><br><span class="line">		h-&gt;action(h);</span><br><span class="line">        ......</span><br><span class="line">	&#125;</span><br><span class="line">    ......</span><br><span class="line">	__local_bh_enable(SOFTIRQ_OFFSET);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>禁止、开启中断下半部的case</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">void __local_bh_enable_ip(unsigned long ip, unsigned int cnt)</span><br><span class="line">&#123;</span><br><span class="line">    ...xxx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void local_bh_enable_ip(unsigned long ip)</span><br><span class="line">&#123;</span><br><span class="line">	__local_bh_enable_ip(ip, SOFTIRQ_DISABLE_OFFSET);&#x2F;&#x2F; 开启中断下半部的preempt_count 和 softirq相关++</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;开启下半部</span><br><span class="line">---------------</span><br><span class="line">&#x2F;&#x2F;禁止下半部</span><br><span class="line">static __always_inline void __local_bh_disable_ip(unsigned long ip, unsigned int cnt)</span><br><span class="line">&#123;</span><br><span class="line">	preempt_count_add(cnt);</span><br><span class="line">	barrier();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void __raw_spin_lock_bh(raw_spinlock_t *lock)</span><br><span class="line">&#123;</span><br><span class="line">	__local_bh_disable_ip(_RET_IP_, SOFTIRQ_LOCK_OFFSET); &#x2F;&#x2F; 禁止中断下半部的preempt_count 和 softirq相关++</span><br><span class="line">	spin_acquire(&amp;lock-&gt;dep_map, 0, 0, _RET_IP_);</span><br><span class="line">	LOCK_CONTENDED(lock, do_raw_spin_trylock, do_raw_spin_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void __lockfunc _raw_spin_lock_bh(raw_spinlock_t *lock)</span><br><span class="line">&#123;</span><br><span class="line">	__raw_spin_lock_bh(lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#define raw_spin_lock_bh(lock)		_raw_spin_lock_bh(lock)</span><br><span class="line"></span><br><span class="line">static __always_inline void spin_lock_bh(spinlock_t *lock)</span><br><span class="line">&#123;</span><br><span class="line">	raw_spin_lock_bh(&amp;lock-&gt;rlock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出来执行软中断 和 禁止中断下半部都属于软中断上下文。<br>（我有个疑问，禁止hard irq 属于硬件中断上下文吗？从 in_irq的定义上看不是，但是和软中断不太一样）</p>
<h2 id="process-context"><a href="#process-context" class="headerlink" title="process context"></a>process context</h2><p>进程上下文，当然不仅仅是进程，只要不是出于NMI、HARD IRQ、SOFT IRQ上下文的都算进程上下文，包括内核线程（包括ksoftirqd、kworker内核线程等）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define in_task()		(!(preempt_count() &amp; \</span><br><span class="line">				   (NMI_MASK | HARDIRQ_MASK | SOFTIRQ_OFFSET)))</span><br></pre></td></tr></table></figure>

<p>中断上下文不会发生进程切换，是一种隐式的进制调度方法。通常也可以使用 <code>preempt_disable</code> 来显式关闭调度，对 preempt_count ++。</p>
<h2 id="atomic-context"><a href="#atomic-context" class="headerlink" title="atomic context"></a>atomic context</h2><p>处于中断上下文中(NMI、hard、soft) 或者 禁止抢占的情况下，都属于原子上下文</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static __always_inline int preempt_count(void)</span><br><span class="line">&#123;</span><br><span class="line">	return READ_ONCE(current_thread_info()-&gt;preempt_count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#define in_atomic()	(preempt_count() !&#x3D; 0)</span><br></pre></td></tr></table></figure>

<p>参考：<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/88883239">Linux中的preempt_count</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://liulangrenaaa.github.io/2020/09/20/%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98/softirq%E4%BD%95%E6%97%B6%E4%BC%9A%E8%A2%AB%E6%89%A7%E8%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Hui">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liulangren Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/20/%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98/softirq%E4%BD%95%E6%97%B6%E4%BC%9A%E8%A2%AB%E6%89%A7%E8%A1%8C/" class="post-title-link" itemprop="url">softirq何时会被执行</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-09-20 14:47:40" itemprop="dateCreated datePublished" datetime="2020-09-20T14:47:40+08:00">2020-09-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-09-21 00:42:02" itemprop="dateModified" datetime="2020-09-21T00:42:02+08:00">2020-09-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">linux内核</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>很多人可能都知道中断irq，但是对软中断softfirq却比较陌生，软中断这个概念是纯软件意义上的，与中断依赖于硬件行为不一样。在linux中，软中断主要用于执行irq中没有执行，但又不是很紧急的事情，现在linux内核中为每个CPU都分配了一个线程 <code>[ksoftirqd/n]</code>，用来执行软中断。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu[root]:&#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing# ps -aux |grep soft</span><br><span class="line">root          10  0.0  0.0      0     0 ?        S    9月19   0:19 [ksoftirqd&#x2F;0]</span><br><span class="line">root          18  0.0  0.0      0     0 ?        S    9月19   0:17 [ksoftirqd&#x2F;1]</span><br><span class="line">root          24  0.0  0.0      0     0 ?        S    9月19   0:18 [ksoftirqd&#x2F;2]</span><br><span class="line">root          30  0.0  0.0      0     0 ?        S    9月19   0:21 [ksoftirqd&#x2F;3]</span><br></pre></td></tr></table></figure>

<p>具体软中断分以下几种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">enum&#123;</span><br><span class="line">	HI_SOFTIRQ&#x3D;0,</span><br><span class="line">	TIMER_SOFTIRQ,</span><br><span class="line">	NET_TX_SOFTIRQ,</span><br><span class="line">	NET_RX_SOFTIRQ,</span><br><span class="line">	BLOCK_SOFTIRQ,</span><br><span class="line">	IRQ_POLL_SOFTIRQ,</span><br><span class="line">	TASKLET_SOFTIRQ,</span><br><span class="line">	SCHED_SOFTIRQ,</span><br><span class="line">	HRTIMER_SOFTIRQ, &#x2F;* Unused, but kept as tools rely on the numbering. Sigh! *&#x2F;</span><br><span class="line">	RCU_SOFTIRQ,    &#x2F;* Preferable RCU should always be the last softirq *&#x2F;</span><br><span class="line">	NR_SOFTIRQS</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>通过 <code>open_softirq</code> 初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static struct softirq_action softirq_vec[NR_SOFTIRQS] __cacheline_aligned_in_smp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void open_softirq(int nr, void (*action)(struct softirq_action *))</span><br><span class="line">&#123;</span><br><span class="line">	softirq_vec[nr].action &#x3D; action;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>触发软中断的时候通过 <code>raise_softirq</code> 来触发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void raise_softirq(unsigned int nr)</span><br><span class="line">&#123;</span><br><span class="line">	unsigned long flags;</span><br><span class="line"></span><br><span class="line">	local_irq_save(flags);</span><br><span class="line">	raise_softirq_irqoff(nr);</span><br><span class="line">	local_irq_restore(flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但tasklet机制直接使用了 <code>raise_softirq_irqoff</code>，搜索代码可以发现其他类型的softirq也基本都是用 <code>raise_softirq_irqoff</code> 触发。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">static void __tasklet_schedule_common(struct tasklet_struct *t,</span><br><span class="line">				      struct tasklet_head __percpu *headp,</span><br><span class="line">				      unsigned int softirq_nr)</span><br><span class="line">&#123;</span><br><span class="line">	struct tasklet_head *head;</span><br><span class="line">	unsigned long flags;</span><br><span class="line"></span><br><span class="line">	local_irq_save(flags);</span><br><span class="line">	head &#x3D; this_cpu_ptr(headp);</span><br><span class="line">	t-&gt;next &#x3D; NULL;</span><br><span class="line">	*head-&gt;tail &#x3D; t;</span><br><span class="line">	head-&gt;tail &#x3D; &amp;(t-&gt;next);</span><br><span class="line">	raise_softirq_irqoff(softirq_nr);</span><br><span class="line">	local_irq_restore(flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来看下 <code>raise_softirq_irqoff</code> 实现，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#define local_softirq_pending_ref irq_stat.__softirq_pending</span><br><span class="line">#define or_softirq_pending(x)	(__this_cpu_or(local_softirq_pending_ref, (x)))</span><br><span class="line"></span><br><span class="line">void __raise_softirq_irqoff(unsigned int nr)</span><br><span class="line">&#123;</span><br><span class="line">	trace_softirq_raise(nr);       &#x2F;&#x2F; 软中断 raise 的 tracepoint 点</span><br><span class="line">	or_softirq_pending(1UL &lt;&lt; nr); &#x2F;&#x2F; 设置当前cpu的软中断pending状态</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inline void raise_softirq_irqoff(unsigned int nr)</span><br><span class="line">&#123;</span><br><span class="line">	__raise_softirq_irqoff(nr);</span><br><span class="line">	if (!in_interrupt())</span><br><span class="line">		wakeup_softirqd(); &#x2F;&#x2F;如果不是中断上下文，就需要唤醒 ksoftirqd来执行相关软中断，这也保证了在线程上下文中软中断可以得到较快执行</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>__raise_softirq_irqoff 仅仅是设置 __softirq_pending 标志位，这有两个作用</p>
<ol>
<li>如果当前是中断irq上下文，在 irq_exit 之后，检查 local_softirq_pending，判断有软中断需要执行</li>
<li>如果当前是线程上下文，在 ksoftirq 线程中检查标志位，最后执行相关的软中断</li>
<li>如果当前在临界区上，在打开中断时，可以检测pending的软中断如何去执行</li>
</ol>
<p>irq_exit的情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">static inline void invoke_softirq(void)</span><br><span class="line">&#123; &#x2F;&#x2F;不考虑软中断强制线程化，简化代码</span><br><span class="line">	if (ksoftirqd_running(local_softirq_pending()))</span><br><span class="line">		return;</span><br><span class="line">   __do_softirq();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void irq_exit(void)  </span><br><span class="line">&#123;</span><br><span class="line">#ifndef __ARCH_IRQ_EXIT_IRQS_DISABLED</span><br><span class="line">	local_irq_disable();</span><br><span class="line">#else</span><br><span class="line">	lockdep_assert_irqs_disabled();</span><br><span class="line">#endif</span><br><span class="line">	account_irq_exit_time(current);</span><br><span class="line">	preempt_count_sub(HARDIRQ_OFFSET);</span><br><span class="line">	if (!in_interrupt() &amp;&amp; local_softirq_pending())</span><br><span class="line">		invoke_softirq();   &#x2F;&#x2F;在中断退出之后，如果有 pending的软中断，就需要执行 软中断</span><br><span class="line"></span><br><span class="line">	tick_irq_exit();</span><br><span class="line">	rcu_irq_exit();</span><br><span class="line">	trace_hardirq_exit(); &#x2F;* must be last! *&#x2F;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ksoftirq线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">static void run_ksoftirqd(unsigned int cpu)</span><br><span class="line">&#123;</span><br><span class="line">	local_irq_disable();</span><br><span class="line">	if (local_softirq_pending()) &#123;</span><br><span class="line">		&#x2F;*</span><br><span class="line">		 * We can safely run softirq on inline stack, as we are not deep</span><br><span class="line">		 * in the task stack here.</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		__do_softirq();</span><br><span class="line">		local_irq_enable();</span><br><span class="line">		cond_resched();</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line">	local_irq_enable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开启中断的情况下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">void __local_bh_enable_ip(unsigned long ip, unsigned int cnt)</span><br><span class="line">&#123;</span><br><span class="line">	WARN_ON_ONCE(in_irq());</span><br><span class="line">	lockdep_assert_irqs_enabled();</span><br><span class="line">	preempt_count_sub(cnt - 1);</span><br><span class="line">	if (unlikely(!in_interrupt() &amp;&amp; local_softirq_pending())) &#123;</span><br><span class="line">        &#x2F;&#x2F; 如果不在中断中，且 softirq 有pending的位，就需要执行软中断</span><br><span class="line">		do_softirq();</span><br><span class="line">	&#125;</span><br><span class="line">	preempt_count_dec();</span><br><span class="line">	preempt_check_resched();</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__local_bh_enable_ip);</span><br><span class="line"></span><br><span class="line">static inline void local_bh_enable(void)</span><br><span class="line">&#123;</span><br><span class="line">	__local_bh_enable_ip(_THIS_IP_, SOFTIRQ_DISABLE_OFFSET);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="do-softirq"><a href="#do-softirq" class="headerlink" title="__do_softirq"></a>__do_softirq</h2><p>不管是退出中断时执行软中断，还是在ksoftirqd中執行软中断，最终都会执行到 <code>__do_softirq</code> 这个函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#define MAX_SOFTIRQ_TIME  msecs_to_jiffies(2)       &#x2F;&#x2F;2ms</span><br><span class="line">#define MAX_SOFTIRQ_RESTART 10</span><br><span class="line"></span><br><span class="line">asmlinkage __visible void __softirq_entry __do_softirq(void)</span><br><span class="line">&#123;</span><br><span class="line">	unsigned long end &#x3D; jiffies + MAX_SOFTIRQ_TIME;</span><br><span class="line">	unsigned long old_flags &#x3D; current-&gt;flags;</span><br><span class="line">	int max_restart &#x3D; MAX_SOFTIRQ_RESTART;</span><br><span class="line">	struct softirq_action *h;</span><br><span class="line">	bool in_hardirq;</span><br><span class="line">	__u32 pending;</span><br><span class="line">	int softirq_bit;</span><br><span class="line"></span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * Mask out PF_MEMALLOC as the current task context is borrowed for the</span><br><span class="line">	 * softirq. A softirq handled, such as network RX, might set PF_MEMALLOC</span><br><span class="line">	 * again if the socket is related to swapping.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	current-&gt;flags &amp;&#x3D; ~PF_MEMALLOC;</span><br><span class="line"></span><br><span class="line">	pending &#x3D; local_softirq_pending();</span><br><span class="line">	account_irq_enter_time(current);</span><br><span class="line"></span><br><span class="line">	__local_bh_disable_ip(_RET_IP_, SOFTIRQ_OFFSET);</span><br><span class="line">	in_hardirq &#x3D; lockdep_softirq_start();</span><br><span class="line"></span><br><span class="line">restart:</span><br><span class="line">	&#x2F;* Reset the pending bitmask before enabling irqs *&#x2F;</span><br><span class="line">	set_softirq_pending(0);</span><br><span class="line"></span><br><span class="line">	local_irq_enable();</span><br><span class="line"></span><br><span class="line">	h &#x3D; softirq_vec;</span><br><span class="line"></span><br><span class="line">	while ((softirq_bit &#x3D; ffs(pending))) &#123; &#x2F;&#x2F;循环执行 pending的软中断</span><br><span class="line">		unsigned int vec_nr;</span><br><span class="line">		int prev_count;</span><br><span class="line"></span><br><span class="line">		h +&#x3D; softirq_bit - 1;</span><br><span class="line"></span><br><span class="line">		vec_nr &#x3D; h - softirq_vec;</span><br><span class="line">		prev_count &#x3D; preempt_count();</span><br><span class="line"></span><br><span class="line">		kstat_incr_softirqs_this_cpu(vec_nr);</span><br><span class="line"></span><br><span class="line">		trace_softirq_entry(vec_nr);  &#x2F;&#x2F;trace 软中断执行</span><br><span class="line">		h-&gt;action(h);</span><br><span class="line">		trace_softirq_exit(vec_nr);   &#x2F;&#x2F;trace 软中断退出</span><br><span class="line">		if (unlikely(prev_count !&#x3D; preempt_count())) &#123;</span><br><span class="line">			pr_err(&quot;huh, entered softirq %u %s %p with preempt_count %08x, exited with %08x?\n&quot;,</span><br><span class="line">			       vec_nr, softirq_to_name[vec_nr], h-&gt;action,</span><br><span class="line">			       prev_count, preempt_count());</span><br><span class="line">			preempt_count_set(prev_count);</span><br><span class="line">		&#125;</span><br><span class="line">		h++;</span><br><span class="line">		pending &gt;&gt;&#x3D; softirq_bit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (__this_cpu_read(ksoftirqd) &#x3D;&#x3D; current)</span><br><span class="line">		rcu_softirq_qs();</span><br><span class="line">	local_irq_disable();</span><br><span class="line"></span><br><span class="line">	pending &#x3D; local_softirq_pending();</span><br><span class="line">	if (pending) &#123;</span><br><span class="line">		if (time_before(jiffies, end) &amp;&amp; !need_resched() &amp;&amp;</span><br><span class="line">		    --max_restart) &#x2F;&#x2F;如果又有pending的软中断了，看看是否执行超时了 2ms，且 restart 不能超过10次</span><br><span class="line">			goto restart; &#x2F;&#x2F;未超时</span><br><span class="line"></span><br><span class="line">		wakeup_softirqd(); &#x2F;&#x2F;超时 2ms，唤醒softirqd去执行软中断</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lockdep_softirq_end(in_hardirq);</span><br><span class="line">	account_irq_exit_time(current);</span><br><span class="line">	__local_bh_enable(SOFTIRQ_OFFSET);</span><br><span class="line">	WARN_ON_ONCE(in_interrupt());</span><br><span class="line">	current_restore_flags(old_flags, PF_MEMALLOC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="do-softirq-1"><a href="#do-softirq-1" class="headerlink" title="do_softirq"></a>do_softirq</h2><p><code>do_softirq</code> 和 其他代码路径下执行软中断不一样，最终执行代码的是 <code>do_softirq_own_stack</code>，后续分析 -=-！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void do_softirq_own_stack(void)</span><br><span class="line">&#123;</span><br><span class="line">	struct irq_stack *irqstk;</span><br><span class="line">	u32 *isp, *prev_esp;</span><br><span class="line"></span><br><span class="line">	irqstk &#x3D; __this_cpu_read(softirq_stack_ptr);</span><br><span class="line"></span><br><span class="line">	&#x2F;* build the stack frame on the softirq stack *&#x2F;</span><br><span class="line">	isp &#x3D; (u32 *) ((char *)irqstk + sizeof(*irqstk));</span><br><span class="line"></span><br><span class="line">	&#x2F;* Push the previous esp onto the stack *&#x2F;</span><br><span class="line">	prev_esp &#x3D; (u32 *)irqstk;</span><br><span class="line">	*prev_esp &#x3D; current_stack_pointer;</span><br><span class="line"></span><br><span class="line">	call_on_stack(__do_softirq, isp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">asmlinkage __visible void do_softirq(void)</span><br><span class="line">&#123;</span><br><span class="line">	unsigned long flags;</span><br><span class="line">	local_irq_save(flags);</span><br><span class="line">	if (local_softirq_pending() &amp;&amp; !ksoftirqd_running(pending))</span><br><span class="line">		do_softirq_own_stack();</span><br><span class="line">	local_irq_restore(flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="如何观察softirq"><a href="#如何观察softirq" class="headerlink" title="如何观察softirq"></a>如何观察softirq</h2><p>在softirq处理过程中（非ksoftirqd线程），在该local cpu上的其他进程是无法进行调度的，不管进程有多高的优先级。因此这点势必对系统实时性造成影响。</p>
<ol>
<li>通过 <code>/proc/softirqs</code> ，配合 <code>watch</code> 命令来观察</li>
<li>通过一些tracepoint来观察</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://liulangrenaaa.github.io/2020/09/19/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/ftrace/ftrace%E5%8F%AF%E4%BB%A5%E7%9C%8B%E7%9A%84%E5%87%A0%E4%B8%AA%E5%8F%82%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Hui">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liulangren Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/19/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/ftrace/ftrace%E5%8F%AF%E4%BB%A5%E7%9C%8B%E7%9A%84%E5%87%A0%E4%B8%AA%E5%8F%82%E6%95%B0/" class="post-title-link" itemprop="url">ftrace可以看的几个参数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-09-19 10:00:40" itemprop="dateCreated datePublished" datetime="2020-09-19T10:00:40+08:00">2020-09-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-09-20 19:46:45" itemprop="dateModified" datetime="2020-09-20T19:46:45+08:00">2020-09-20</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">linux内核</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Ftrace是一个内部跟踪器，旨在帮助系统的开发人员和设计人员查找内核内部发生的情况。 它可以用于调试或分析在用户空间之外发生的延迟和性能问题。</p>
<p>尽管通常将ftrace视为函数跟踪器，但实际上它是多个分类跟踪实用程序的框架。 可以进行延迟跟踪，以检查禁用和启用中断之间的情况以及抢占以及从唤醒任务到计划任务的时间。</p>
<p>ftrace的最常见用途之一是事件跟踪。 整个内核中有数百个静态事件点，可以通过tracefs文件系统启用这些事件点，以查看内核某些部分的情况。</p>
<h2 id="irqsoff"><a href="#irqsoff" class="headerlink" title="irqsoff"></a>irqsoff</h2><p>我们都知道linux执行中断的时候都是关中断的，也不存在什么中断嵌套，中断被禁时CPU无法响应任何其他外部事件（除了NMI和SMI）。<br>万一某个驱动开发者代码没有注意将临界区设置的比较大，或者中断处理函数中执行了较多内容，就会直接导致调度延迟增大，直接表现为业务抖动较大，我们有没有什么手段观测这个关中断的时间长短呢?答案是肯定的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu[root]:&#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing# cat &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;available_tracers </span><br><span class="line">hwlat blk mmiotrace function_graph wakeup_dl wakeup_rt wakeup irqsoff function nop</span><br></pre></td></tr></table></figure>
<p>irqsoff 这个 tracer 就是来完成这个使命的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu[root]:~# echo 0 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;tracing_on </span><br><span class="line">sh@ubuntu[root]:~# echo irqsoff &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;current_tracer</span><br><span class="line">sh@ubuntu[root]:~# echo 0 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;tracing_max_latency </span><br><span class="line">sh@ubuntu[root]:~# echo 1 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;tracing_on </span><br><span class="line">sh@ubuntu[root]:~# sleep 5</span><br><span class="line">sh@ubuntu[root]:~# echo 0 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;tracing_on </span><br><span class="line">sh@ubuntu[root]:~# cat &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;trace | head -n 30</span><br><span class="line"># tracer: irqsoff</span><br><span class="line">#</span><br><span class="line"># irqsoff latency trace v1.1.5 on 5.4.44</span><br><span class="line"># --------------------------------------------------------------------</span><br><span class="line"># latency: 769 us, #15&#x2F;15, CPU#2 | (M:desktop VP:0, KP:0, SP:0 HP:0 #P:4)</span><br><span class="line">#    -----------------</span><br><span class="line">#    | task: kworker&#x2F;2:0-5528 (uid:0 nice:0 policy:0 rt_prio:0)</span><br><span class="line">#    -----------------</span><br><span class="line">#  &#x3D;&gt; started at: e1000_update_stats</span><br><span class="line">#  &#x3D;&gt; ended at:   e1000_update_stats</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#                  _------&#x3D;&gt; CPU#            </span><br><span class="line">#                 &#x2F; _-----&#x3D;&gt; irqs-off        </span><br><span class="line">#                | &#x2F; _----&#x3D;&gt; need-resched    </span><br><span class="line">#                || &#x2F; _---&#x3D;&gt; hardirq&#x2F;softirq </span><br><span class="line">#                ||| &#x2F; _--&#x3D;&gt; preempt-depth   </span><br><span class="line">#                |||| &#x2F;     delay            </span><br><span class="line">#  cmd     pid   ||||| time  |   caller      </span><br><span class="line">#     \   &#x2F;      |||||  \    |   &#x2F;         </span><br><span class="line">kworker&#x2F;-5528    2d...    0us!: _raw_spin_lock_irqsave &lt;-e1000_update_stats</span><br><span class="line">kworker&#x2F;-5528    2d...  609us : e1000_read_phy_reg &lt;-e1000_update_stats</span><br><span class="line">kworker&#x2F;-5528    2d...  610us : _raw_spin_lock_irqsave &lt;-e1000_read_phy_reg</span><br><span class="line">kworker&#x2F;-5528    2d...  620us : __const_udelay &lt;-e1000_read_phy_reg</span><br><span class="line">kworker&#x2F;-5528    2d...  620us+: delay_tsc &lt;-__const_udelay</span><br><span class="line">kworker&#x2F;-5528    2d...  678us : _raw_spin_unlock_irqrestore &lt;-e1000_read_phy_reg</span><br><span class="line">kworker&#x2F;-5528    2d...  679us : e1000_read_phy_reg &lt;-e1000_update_stats</span><br><span class="line">kworker&#x2F;-5528    2d...  679us : _raw_spin_lock_irqsave &lt;-e1000_read_phy_reg</span><br><span class="line">kworker&#x2F;-5528    2d...  687us : __const_udelay &lt;-e1000_read_phy_reg</span><br><span class="line">kworker&#x2F;-5528    2d...  688us+: delay_tsc &lt;-__const_udelay</span><br><span class="line">kworker&#x2F;-5528    2d...  770us : tracer_hardirqs_on &lt;-e1000_update_stats</span><br><span class="line">kworker&#x2F;-5528    2d...  774us : &lt;stack trace&gt;</span><br><span class="line"> &#x3D;&gt; e1000_update_stats</span><br><span class="line"> &#x3D;&gt; e1000_watchdog</span><br><span class="line"> &#x3D;&gt; process_one_work</span><br><span class="line"> &#x3D;&gt; worker_thread</span><br><span class="line"> &#x3D;&gt; kthread</span><br><span class="line"> &#x3D;&gt; ret_from_fork</span><br><span class="line">sh@ubuntu[root]:~# cat &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;tracing_max_latency </span><br><span class="line">769</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>tracing_max_latency</code> 是 769，意味着系统最长关中断时间就是 769us.<br>(要重置最大值，需要将0回显到tracing_max_latency中)</p>
<p>这是未设置函数跟踪的结果 可以 <code>echo 1 &gt; /sys/kernel/debug/tracing/options/function-trace</code> 获取更详细输出</p>
<h2 id="preemptoff"><a href="#preemptoff" class="headerlink" title="preemptoff"></a>preemptoff</h2><p>禁用抢占功能后，我们可能会收到中断，但无法抢占该任务，优先级较高的任务必须等待再次启用抢占功能，才能抢占优先级较低的任务。</p>
<p>preemptoff跟踪程序将跟踪禁用抢占的位置。 与irqsoff跟踪器一样，它记录禁用了抢占的最大延迟。 preemptoff跟踪器的控制与irqsoff跟踪器非常相似。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># echo preemptoff &gt; current_tracer</span><br><span class="line"># echo 1 &gt; tracing_on</span><br><span class="line"># echo 0 &gt; tracing_max_latency</span><br><span class="line"># ls -ltr</span><br><span class="line">[...]</span><br><span class="line"># echo 0 &gt; tracing_on</span><br><span class="line"># cat trace</span><br><span class="line"># tracer: preemptoff</span><br><span class="line">#</span><br><span class="line"># preemptoff latency trace v1.1.5 on 3.8.0-test+</span><br><span class="line"># --------------------------------------------------------------------</span><br><span class="line"># latency: 46 us, #4&#x2F;4, CPU#1 | (M:preempt VP:0, KP:0, SP:0 HP:0 #P:4)</span><br><span class="line">#    -----------------</span><br><span class="line">#    | task: sshd-1991 (uid:0 nice:0 policy:0 rt_prio:0)</span><br><span class="line">#    -----------------</span><br><span class="line">#  &#x3D;&gt; started at: do_IRQ</span><br><span class="line">#  &#x3D;&gt; ended at:   do_IRQ</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#                  _------&#x3D;&gt; CPU#</span><br><span class="line">#                 &#x2F; _-----&#x3D;&gt; irqs-off</span><br><span class="line">#                | &#x2F; _----&#x3D;&gt; need-resched</span><br><span class="line">#                || &#x2F; _---&#x3D;&gt; hardirq&#x2F;softirq</span><br><span class="line">#                ||| &#x2F; _--&#x3D;&gt; preempt-depth</span><br><span class="line">#                |||| &#x2F;     delay</span><br><span class="line">#  cmd     pid   ||||| time  |   caller</span><br><span class="line">#     \   &#x2F;      |||||  \    |   &#x2F;</span><br><span class="line">    sshd-1991    1d.h.    0us+: irq_enter &lt;-do_IRQ</span><br><span class="line">    sshd-1991    1d..1   46us : irq_exit &lt;-do_IRQ</span><br><span class="line">    sshd-1991    1d..1   47us+: trace_preempt_on &lt;-do_IRQ</span><br><span class="line">    sshd-1991    1d..1   52us : &lt;stack trace&gt;</span><br><span class="line"> &#x3D;&gt; sub_preempt_count</span><br><span class="line"> &#x3D;&gt; irq_exit</span><br><span class="line"> &#x3D;&gt; do_IRQ</span><br><span class="line"> &#x3D;&gt; ret_from_intr</span><br></pre></td></tr></table></figure>

<h2 id="preemptirqsoff"><a href="#preemptirqsoff" class="headerlink" title="preemptirqsoff"></a>preemptirqsoff</h2><p>preemptirqsoff 是以上两者的和，会显示禁止 抢占或者中断的最长时间<br>比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">local_irq_disable();</span><br><span class="line">call_function_with_irqs_off();</span><br><span class="line">preempt_disable();</span><br><span class="line">call_function_with_irqs_and_preemption_off();</span><br><span class="line">local_irq_enable();</span><br><span class="line">call_function_with_preemption_off();</span><br><span class="line">preempt_enable();</span><br></pre></td></tr></table></figure>

<h2 id="wakeup、wakeup-rt"><a href="#wakeup、wakeup-rt" class="headerlink" title="wakeup、wakeup_rt"></a>wakeup、wakeup_rt</h2><p>wakeup、wakeup_rt 是 trace一个进程从进入CPU的就绪队列到真正被执行的时间的一个tracer，即跟踪调度器的延迟。</p>
<p>参考<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v4.18/trace/ftrace.html#irqsoff">ftrace 内核文档</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Su Hui</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  















  








  

  

</body>
</html>

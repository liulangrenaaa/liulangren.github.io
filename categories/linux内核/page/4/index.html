<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>分类: linux内核 - liulangren Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="liulangren blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="liulangren blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="liulangren Blog"><meta property="og:url" content="https://liulangrenaaa.github.io/"><meta property="og:site_name" content="liulangren Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liulangrenaaa.github.io/img/og_image.png"><meta property="article:author" content="Su Hui"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liulangrenaaa.github.io"},"headline":"liulangren Blog","image":["https://liulangrenaaa.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Su Hui"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?cabdc5b9b70bb83fa919a6ebeb439f93";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=PTKX6HMR55" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'PTKX6HMR55');</script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">分类</a></li><li class="is-active"><a href="#" aria-current="page">linux内核</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-19T02:00:40.000Z" title="9/19/2020, 10:00:40 AM">2020-09-19</time>发表</span><span class="level-item"><time dateTime="2020-09-20T11:46:45.000Z" title="9/20/2020, 7:46:45 PM">2020-09-20</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">7 分钟读完 (大约1055个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/09/19/%E5%86%85%E6%A0%B8%E8%A7%82%E6%B5%8B/ftrace/ftrace%E5%8F%AF%E4%BB%A5%E7%9C%8B%E7%9A%84%E5%87%A0%E4%B8%AA%E5%8F%82%E6%95%B0/">ftrace可以看的几个参数</a></h1><div class="content"><p>Ftrace是一个内部跟踪器，旨在帮助系统的开发人员和设计人员查找内核内部发生的情况。 它可以用于调试或分析在用户空间之外发生的延迟和性能问题。</p>
<p>尽管通常将ftrace视为函数跟踪器，但实际上它是多个分类跟踪实用程序的框架。 可以进行延迟跟踪，以检查禁用和启用中断之间的情况以及抢占以及从唤醒任务到计划任务的时间。</p>
<p>ftrace的最常见用途之一是事件跟踪。 整个内核中有数百个静态事件点，可以通过tracefs文件系统启用这些事件点，以查看内核某些部分的情况。</p>
<h2 id="irqsoff"><a href="#irqsoff" class="headerlink" title="irqsoff"></a>irqsoff</h2><p>我们都知道linux执行中断的时候都是关中断的，也不存在什么中断嵌套，中断被禁时CPU无法响应任何其他外部事件（除了NMI和SMI）。<br>万一某个驱动开发者代码没有注意将临界区设置的比较大，或者中断处理函数中执行了较多内容，就会直接导致调度延迟增大，直接表现为业务抖动较大，我们有没有什么手段观测这个关中断的时间长短呢?答案是肯定的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu[root]:&#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing# cat &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;available_tracers </span><br><span class="line">hwlat blk mmiotrace function_graph wakeup_dl wakeup_rt wakeup irqsoff function nop</span><br></pre></td></tr></table></figure>
<p>irqsoff 这个 tracer 就是来完成这个使命的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">sh@ubuntu[root]:~# echo 0 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;tracing_on </span><br><span class="line">sh@ubuntu[root]:~# echo irqsoff &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;current_tracer</span><br><span class="line">sh@ubuntu[root]:~# echo 0 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;tracing_max_latency </span><br><span class="line">sh@ubuntu[root]:~# echo 1 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;tracing_on </span><br><span class="line">sh@ubuntu[root]:~# sleep 5</span><br><span class="line">sh@ubuntu[root]:~# echo 0 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;tracing_on </span><br><span class="line">sh@ubuntu[root]:~# cat &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;trace | head -n 30</span><br><span class="line"># tracer: irqsoff</span><br><span class="line">#</span><br><span class="line"># irqsoff latency trace v1.1.5 on 5.4.44</span><br><span class="line"># --------------------------------------------------------------------</span><br><span class="line"># latency: 769 us, #15&#x2F;15, CPU#2 | (M:desktop VP:0, KP:0, SP:0 HP:0 #P:4)</span><br><span class="line">#    -----------------</span><br><span class="line">#    | task: kworker&#x2F;2:0-5528 (uid:0 nice:0 policy:0 rt_prio:0)</span><br><span class="line">#    -----------------</span><br><span class="line">#  &#x3D;&gt; started at: e1000_update_stats</span><br><span class="line">#  &#x3D;&gt; ended at:   e1000_update_stats</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#                  _------&#x3D;&gt; CPU#            </span><br><span class="line">#                 &#x2F; _-----&#x3D;&gt; irqs-off        </span><br><span class="line">#                | &#x2F; _----&#x3D;&gt; need-resched    </span><br><span class="line">#                || &#x2F; _---&#x3D;&gt; hardirq&#x2F;softirq </span><br><span class="line">#                ||| &#x2F; _--&#x3D;&gt; preempt-depth   </span><br><span class="line">#                |||| &#x2F;     delay            </span><br><span class="line">#  cmd     pid   ||||| time  |   caller      </span><br><span class="line">#     \   &#x2F;      |||||  \    |   &#x2F;         </span><br><span class="line">kworker&#x2F;-5528    2d...    0us!: _raw_spin_lock_irqsave &lt;-e1000_update_stats</span><br><span class="line">kworker&#x2F;-5528    2d...  609us : e1000_read_phy_reg &lt;-e1000_update_stats</span><br><span class="line">kworker&#x2F;-5528    2d...  610us : _raw_spin_lock_irqsave &lt;-e1000_read_phy_reg</span><br><span class="line">kworker&#x2F;-5528    2d...  620us : __const_udelay &lt;-e1000_read_phy_reg</span><br><span class="line">kworker&#x2F;-5528    2d...  620us+: delay_tsc &lt;-__const_udelay</span><br><span class="line">kworker&#x2F;-5528    2d...  678us : _raw_spin_unlock_irqrestore &lt;-e1000_read_phy_reg</span><br><span class="line">kworker&#x2F;-5528    2d...  679us : e1000_read_phy_reg &lt;-e1000_update_stats</span><br><span class="line">kworker&#x2F;-5528    2d...  679us : _raw_spin_lock_irqsave &lt;-e1000_read_phy_reg</span><br><span class="line">kworker&#x2F;-5528    2d...  687us : __const_udelay &lt;-e1000_read_phy_reg</span><br><span class="line">kworker&#x2F;-5528    2d...  688us+: delay_tsc &lt;-__const_udelay</span><br><span class="line">kworker&#x2F;-5528    2d...  770us : tracer_hardirqs_on &lt;-e1000_update_stats</span><br><span class="line">kworker&#x2F;-5528    2d...  774us : &lt;stack trace&gt;</span><br><span class="line"> &#x3D;&gt; e1000_update_stats</span><br><span class="line"> &#x3D;&gt; e1000_watchdog</span><br><span class="line"> &#x3D;&gt; process_one_work</span><br><span class="line"> &#x3D;&gt; worker_thread</span><br><span class="line"> &#x3D;&gt; kthread</span><br><span class="line"> &#x3D;&gt; ret_from_fork</span><br><span class="line">sh@ubuntu[root]:~# cat &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;tracing_max_latency </span><br><span class="line">769</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>tracing_max_latency</code> 是 769，意味着系统最长关中断时间就是 769us.<br>(要重置最大值，需要将0回显到tracing_max_latency中)</p>
<p>这是未设置函数跟踪的结果 可以 <code>echo 1 &gt; /sys/kernel/debug/tracing/options/function-trace</code> 获取更详细输出</p>
<h2 id="preemptoff"><a href="#preemptoff" class="headerlink" title="preemptoff"></a>preemptoff</h2><p>禁用抢占功能后，我们可能会收到中断，但无法抢占该任务，优先级较高的任务必须等待再次启用抢占功能，才能抢占优先级较低的任务。</p>
<p>preemptoff跟踪程序将跟踪禁用抢占的位置。 与irqsoff跟踪器一样，它记录禁用了抢占的最大延迟。 preemptoff跟踪器的控制与irqsoff跟踪器非常相似。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># echo preemptoff &gt; current_tracer</span><br><span class="line"># echo 1 &gt; tracing_on</span><br><span class="line"># echo 0 &gt; tracing_max_latency</span><br><span class="line"># ls -ltr</span><br><span class="line">[...]</span><br><span class="line"># echo 0 &gt; tracing_on</span><br><span class="line"># cat trace</span><br><span class="line"># tracer: preemptoff</span><br><span class="line">#</span><br><span class="line"># preemptoff latency trace v1.1.5 on 3.8.0-test+</span><br><span class="line"># --------------------------------------------------------------------</span><br><span class="line"># latency: 46 us, #4&#x2F;4, CPU#1 | (M:preempt VP:0, KP:0, SP:0 HP:0 #P:4)</span><br><span class="line">#    -----------------</span><br><span class="line">#    | task: sshd-1991 (uid:0 nice:0 policy:0 rt_prio:0)</span><br><span class="line">#    -----------------</span><br><span class="line">#  &#x3D;&gt; started at: do_IRQ</span><br><span class="line">#  &#x3D;&gt; ended at:   do_IRQ</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#                  _------&#x3D;&gt; CPU#</span><br><span class="line">#                 &#x2F; _-----&#x3D;&gt; irqs-off</span><br><span class="line">#                | &#x2F; _----&#x3D;&gt; need-resched</span><br><span class="line">#                || &#x2F; _---&#x3D;&gt; hardirq&#x2F;softirq</span><br><span class="line">#                ||| &#x2F; _--&#x3D;&gt; preempt-depth</span><br><span class="line">#                |||| &#x2F;     delay</span><br><span class="line">#  cmd     pid   ||||| time  |   caller</span><br><span class="line">#     \   &#x2F;      |||||  \    |   &#x2F;</span><br><span class="line">    sshd-1991    1d.h.    0us+: irq_enter &lt;-do_IRQ</span><br><span class="line">    sshd-1991    1d..1   46us : irq_exit &lt;-do_IRQ</span><br><span class="line">    sshd-1991    1d..1  
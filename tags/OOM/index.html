<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>标签: OOM - liulangren Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="liulangren blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="liulangren blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="liulangren Blog"><meta property="og:url" content="https://liulangrenaaa.github.io/"><meta property="og:site_name" content="liulangren Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liulangrenaaa.github.io/img/og_image.png"><meta property="article:author" content="Su Hui"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liulangrenaaa.github.io"},"headline":"liulangren Blog","image":["https://liulangrenaaa.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Su Hui"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?cabdc5b9b70bb83fa919a6ebeb439f93";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=PTKX6HMR55" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'PTKX6HMR55');</script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="liulangren Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">标签</a></li><li class="is-active"><a href="#" aria-current="page">OOM</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-05T11:00:00.000Z" title="9/5/2020, 7:00:00 PM">2020-09-05</time>发表</span><span class="level-item"><time dateTime="2021-02-19T06:01:01.841Z" title="2/19/2021, 2:01:01 PM">2021-02-19</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/linux%E5%86%85%E6%A0%B8/">linux内核</a></span><span class="level-item">10 分钟读完 (大约1518个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/09/05/memory/%E9%9D%A2%E8%AF%95/%E5%86%99%E4%B8%80%E4%B8%AA%E6%B6%88%E8%80%97%E5%AE%8C%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%9A%84%E7%A8%8B%E5%BA%8F/%E6%B6%88%E8%80%97%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98/">快速消耗完物理内存</a></h1><div class="content"><h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p>之前遇到一个面试，是写一个快速消耗完物理内存的代码</p>
<p>需要注意的是是物理内存，很多不了解内核的同学往往会忽视这一点<br>主要考察的是linux 内存分配的延迟分配策略</p>
<h2 id="内存分配的延迟分配"><a href="#内存分配的延迟分配" class="headerlink" title="内存分配的延迟分配"></a>内存分配的延迟分配</h2><p>主要是说linux 应用程序在通过brk系统调用向linux内核申请内存时，都是申请的虚拟内存，<br>只有在这个内存真正被使用（访问）的时候，kernel会发生缺页中断，进而去分配物理内存。</p>
<h2 id="解答"><a href="#解答" class="headerlink" title="解答"></a>解答</h2><p>那这个问题就变成了，分配很多内存，且分配之后去访问一下，让内核产生缺页中断，给申请的虚拟内存分配物理内存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv)</span><br><span class="line">&#123;</span><br><span class="line">    int *p &#x3D; NULL;</span><br><span class="line">    int i &#x3D; 0, j &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    for (i &#x3D; 0; i &lt; (1 &lt;&lt; 30); i++) &#123;</span><br><span class="line">        for (j &#x3D; 0; i &lt; (1 &lt;&lt; 30); j++) &#123;</span><br><span class="line">            p &#x3D; (int *)malloc(4096);</span><br><span class="line">            p &#x3D; 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我在ubuntu20.04上运行这个代码之后，几秒钟后这个a.out就被oomkill干掉了<br>dmesg 最后打印的消息是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">[992416.124437] node invoked oom-killer: gfp_mask&#x3D;0x100cca(GFP_HIGHUSER_MOVABLE), order&#x3D;0, oom_score_adj&#x3D;0</span><br><span class="line">[992416.128825] CPU: 1 PID: 44301 Comm: node Kdump: loaded Not tainted 5.4.44 #1</span><br><span class="line">[992416.128825] Hardware name: VMware, Inc. VMware Virtual Platform&#x2F;440BX Desktop Reference Platform, BIOS 6.00 07&#x2F;29&#x2F;2019</span><br><span class="line">[992416.128826] Call Trace:</span><br><span class="line">[992416.144917]  dump_stack+0x6d&#x2F;0x9a</span><br><span class="line">[992416.145738]  dump_header+0x4f&#x2F;0x1eb</span><br><span class="line">[992416.145742]  oom_kill_process.cold+0xb&#x2F;0x10</span><br><span class="line">[992416.145743]  out_of_memory+0x1bc&#x2F;0x490</span><br><span class="line">[992416.145777]  __alloc_pages_slowpath+0xd5e&#x2F;0xe50</span><br><span class="line">[992416.145793]  ? __switch_to_asm+0x40&#x2F;0x70</span><br><span class="line">[992416.145795]  __alloc_pages_nodemask+0x2d0&#x2F;0x320</span><br><span class="line">[992416.145811]  alloc_pages_current+0x87&#x2F;0xe0</span><br><span class="line">[992416.146058]  __page_cache_alloc+0x72&#x2F;0x90</span><br><span class="line">[992416.146061]  pagecache_get_page+0xbf&#x2F;0x300</span><br><span class="line">[992416.146062]  filemap_fault+0x69a&#x2F;0xa40</span><br><span class="line">[992416.146143]  ? unlock_page_memcg+0x12&#x2F;0x20</span><br><span class="line">[992416.146166]  ? page_add_file_rmap+0xff&#x2F;0x1a0</span><br><span class="line">[992416.146181]  ? xas_load+0xd&#x2F;0x80</span><br><span class="line">[992416.146182]  ? xas_find+0x17f&#x2F;0x1c0</span><br><span class="line">[992416.146184]  ? filemap_map_pages+0x24c&#x2F;0x380</span><br><span class="line">[992416.146458]  ext4_filemap_fault+0x32&#x2F;0x46</span><br><span class="line">[992416.146475]  __do_fault+0x3c&#x2F;0x130</span><br><span class="line">[992416.146477]  __handle_mm_fault+0xff5&#x2F;0x1700</span><br><span class="line">[992416.146723]  ? hrtimer_init_sleeper+0x90&#x2F;0x90</span><br><span class="line">[992416.146726]  handle_mm_fault+0xca&#x2F;0x200</span><br><span class="line">[992416.147382]  do_user_addr_fault+0x1f9&#x2F;0x450</span><br><span class="line">[992416.147385]  __do_page_fault+0x58&#x2F;0x90</span><br><span class="line">[992416.147386]  do_page_fault+0x2c&#x2F;0xe0</span><br><span class="line">[992416.147387]  page_fault+0x34&#x2F;0x40</span><br><span class="line">[992416.147623] RIP: 0033:0x7f9a73ac1210</span><br><span class="line">[992416.147628] Code: Bad RIP value.</span><br><span class="line">[992416.147629] RSP: 002b:00007ffc77fb2448 EFLAGS: 00010213</span><br><span class="line">[992416.147646] RAX: 00007f9a739de698 RBX: 000000000000000b RCX: 00007f9a73b03266</span><br><span class="line">[992416.147646] RDX: 0000000000000400 RSI: 00007ffc77fb24a0 RDI: 0000000000000001</span><br><span class="line">[992416.147974] RBP: 00007ffc77fb5560 R08: 0000000000000000 R09: 0000000000000008</span><br><span class="line">[992416.147975] R10: 0000000000001388 R11: 0000000000000000 R12: 0000000000001388</span><br><span class="line">[992416.147976] R13: 0000000000000000 R14: 0000000002887f98 R15: 0000000002887f40</span><br><span class="line">[992416.148030] Mem-Info:</span><br><span class="line">[992416.148188] active_anon:478453 inactive_anon:255010 isolated_anon:0</span><br><span class="line">                 active_file:161 inactive_file:27 isolated_file:0</span><br><span class="line">                 unevictable:16 dirty:0 writeback:0 unstable:0</span><br><span class="line">                 slab_reclaimable:26060 slab_unreclaimable:48649</span><br><span class="line">                 mapped:35873 shmem:35877 pagetables:8285 bounce:0</span><br><span class="line">                 free:21419 free_pcp:0 free_cma:0</span><br><span class="line">[992416.148190] Node 0 active_anon:1913812kB inactive_anon:1020040kB active_file:644kB inactive_file:108kB unevictable:64kB isolated(anon):0kB isolated(file):0kB mapped:143492kB dirty:0kB writeback:0kB shmem:143508kB shmem_thp: 0kB shmem_pmdmapped: 0kB anon_thp: 0kB writeback_tmp:0kB unstable:0kB all_unreclaimable? no</span><br><span class="line">[992416.148191] Node 0 DMA free:14928kB min:284kB low:352kB high:420kB active_anon:748kB inactive_anon:104kB active_file:0kB inactive_file:0kB unevictable:0kB writepending:0kB present:15988kB managed:15904kB mlocked:0kB kernel_stack:0kB pagetables:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB</span><br><span class="line">[992416.148193] lowmem_reserve[]: 0 2772 3665 3665 3665</span><br><span class="line">[992416.148194] Node 0 DMA32 free:54416kB min:50896kB low:63620kB high:76344kB active_anon:1478944kB inactive_anon:856680kB active_file:20kB inactive_file:416kB unevictable:0kB writepending:0kB present:3129152kB managed:2867008kB mlocked:0kB kernel_stack:10032kB pagetables:26552kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB</span><br><span class="line">[992416.148196] lowmem_reserve[]: 0 0 893 893 893</span><br><span class="line">[992416.148196] Node 0 Normal free:16332kB min:16400kB low:20500kB high:24600kB active_anon:434120kB inactive_anon:163256kB active_file:476kB inactive_file:412kB unevictable:64kB writepending:0kB present:1048576kB managed:922756kB mlocked:64kB kernel_stack:7056kB pagetables:6588kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB</span><br><span class="line">[992416.148198] lowmem_reserve[]: 0 0 0 0 0</span><br><span class="line">[992416.148199] Node 0 DMA: 8*4kB (UM) 6*8kB (UM) 6*16kB (U) 7*32kB (UM) 1*64kB (U) 1*128kB (M) 0*256kB 0*512kB 2*1024kB (UM) 0*2048kB 3*4096kB (ME) &#x3D; 14928kB</span><br><span class="line">[992416.148202] Node 0 DMA32: 2340*4kB (UME) 1077*8kB (UME) 606*16kB (UME) 419*32kB (UME) 180*64kB (UME) 18*128kB (UME) 1*256kB (M) 0*512kB 0*1024kB 0*2048kB 0*4096kB &#x3D; 55160kB</span><br><span class="line">[992416.148205] Node 0 Normal: 1046*4kB (UME) 629*8kB (UME) 246*16kB (UME) 110*32kB (UME) 2*64kB (M) 0*128kB 0*256kB 0*512kB 0*1024kB 0*2048kB 0*4096kB &#x3D; 16800kB</span><br><span class="line">[992416.148413] Node 0 hugepages_total&#x3D;0 hugepages_fr